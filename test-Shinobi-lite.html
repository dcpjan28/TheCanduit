<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="docTitle">The Canduit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link id="themeFont" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            color: #E0E0E0;
            background-color: #1a1a1a;
            background-image: var(--bg-image);
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .theme-heading {
            font-family: var(--theme-font);
            color: var(--theme-color);
        }
        .energy-color {
            color: #00FFD1;
        }
        .task-card {
            transition: all 0.3s ease;
        }
        .task-card.completed {
            opacity: 0.6;
            transform: scale(0.98);
        }
        .task-button:disabled {
            background-color: #6C757D;
            cursor: not-allowed;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #2b2b2b;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
        }
        .scroll-container {
            background-color: rgba(43, 43, 43, 0.85);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--theme-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .player-image {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid #00FFD1;
            cursor: pointer;
        }
        .action-buttons-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
        }
        .action-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            line-height: 1;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .energy-summary-panel {
            background-color: #3b3b3b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .energy-summary-item {
            background-color: #4a4a4a;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .fullscreen-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .fullscreen-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            cursor: pointer;
        }
        /* Increased z-index for the confirmation modal */
        #confirmationModal {
            z-index: 2000;
        }
        #playerPanel {
            background-color: rgba(17, 24, 39, 0.7); /* Adjusted for transparency */
        }
        .task-button {
            white-space: normal;
            word-break: break-word;
            text-align: center;
        }
        .task-name-text {
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .highlight-tutorial {
            border: 4px solid var(--theme-color);
            box-shadow: 0 0 20px var(--theme-color);
            transition: all 0.5s ease-in-out;
        }
        .action-icon-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .action-icon-button:hover {
            transform: scale(1.1);
        }
        .task-action-container {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body class="antialiased p-4 sm:p-8">
    
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="fixed inset-0 bg-[#0c0c0c] flex items-center justify-center p-8 z-[3000]">
        <div class="text-center transition-opacity duration-1000 ease-in-out">
            <h1 class="text-6xl sm:text-7xl font-bold mb-4 theme-heading">THE CANDUIT</h1>
            <p class="max-w-2xl text-lg text-gray-300 mx-auto leading-relaxed">
                Welcome, initiate. The Canduit is a device that connects your consciousness with a parallel dimension, transforming your daily tasks into a grand narrative. Your hard work here fuels your progress there. Await connection...
            </p>
            <button id="initiateButton" class="mt-8 bg-[#00FFD1] text-black font-bold py-4 px-12 rounded-full text-lg shadow-md hover:bg-opacity-80 transition-all active:scale-95 uppercase tracking-wide">
                Initiate Canduit
            </button>
        </div>
    </div>

    <header class="text-center mb-10 p-4 bg-black bg-opacity-70 rounded-lg">
        <h1 id="appTitleDisplay" class="text-3xl sm:text-4xl md:text-5xl font-black theme-heading">The Canduit</h1>
        <p class="mt-2 text-lg sm:text-xl text-[#00FFD1]">Mastering your Skills and becoming a Master.</p>
        <div class="mt-4 flex flex-wrap items-center justify-center space-x-4 space-y-2 relative">
            <div>
                <span class="text-2xl sm:text-3xl font-bold text-[#00FFD1]">Total Energy:</span>
                <span id="totalPointsDisplay" class="ml-2 text-3xl sm:text-4xl font-extrabold energy-color">0</span>
            </div>
        </div>
    </header>

    <!-- Path of the Player Storyteller -->
    <section class="lg:col-span-3 mb-8">
        <div id="playerPanel" class="bg-gray-900 rounded-xl shadow-lg p-6 sm:p-8">
            <h2 id="pathHeading" class="text-2xl sm:text-3xl font-bold theme-heading text-center">Path of the <span id="playerTitleDisplay">Player</span></h2>
            <p class="text-center text-gray-300 mb-6 max-w-2xl mx-auto">Track your journey and see your story unfold. Enter a character name and complete tasks to unlock your next chapter.</p>
            <div class="flex flex-col items-center">
                <div class="relative group">
                    <img id="playerImageDisplay" src="https://placehold.co/150x150/073B4C/FFF?text=Your+Player" alt="Your Player Avatar" class="player-image mb-4">
                    <button id="openDescriptionModal" class="absolute bottom-4 right-4 bg-[#00FFD1] text-black p-2 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95" title="Edit Description">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M12.854.146a.5.5 0 0 0-.707 0L7.427 4.81l-4.242 4.243a.5.5 0 0 0-.138.287l-.634 3.17a.5.5 0 0 0 .634.634l3.17-.634a.5.5 0 0 0 .287-.138l4.243-4.242 4.661-4.661a.5.5 0 0 0 0-.707l-2.122-2.122a.5.5 0 0 0-.707 0zM11.666 3.19l1.414 1.414-3.535 3.536-1.414-1.414 3.535-3.536z"/>
                        </svg>
                    </button>
                </div>
                
                <input type="file" id="playerImageInput" accept="image/*" class="hidden">
                <label for="playerImageInput" class="bg-[#00FFD1] text-black font-bold py-2 px-4 rounded-full shadow-md cursor-pointer hover:bg-opacity-90 transition-all active:scale-95 mb-4">
                    Choose Your <span id="playerTitleDisplay2">Player</span>'s Image
                </label>
                
                <div class="text-center mt-2">
                    <p class="text-lg font-bold text-gray-200">Name: <span id="characterNameDisplay" class="energy-color"></span></p>
                </div>
                <div class="text-center mt-2">
                    <p class="text-lg font-bold text-gray-200">Rank: <span id="playerRankDisplay" class="energy-color">Novice</span></p>
                </div>
                <div class="text-center mt-2">
                    <p class="text-lg font-bold text-gray-200">Arc Progress: <span id="arcIndicatorDisplay" class="energy-color">N/A</span></p>
                </div>

                <div id="imageGeneratorSection" class="mt-6 flex flex-col items-center hidden">
                    <h4 class="text-md font-bold mb-2 theme-heading">Create Your <span id="playerTitleDisplay3">Player</span>'s Scene</h4>
                    <p id="imageStatus" class="mb-4 text-sm text-gray-400">Generate a visual of your latest adventure!</p>
                    <div class="flex space-x-4">
                        <button id="generateImageButton" class="bg-[#0077B6] text-white font-bold py-3 px-6 rounded-full shadow-md cursor-not-allowed" disabled>Generate Player Image</button>
                        <button id="setProfileImageButton" class="bg-[#00FFD1] text-black font-bold py-3 px-6 rounded-full shadow-md hidden" disabled>Set as Profile Image</button>
                    </div>
                    <div id="imageLoadingIndicator" class="hidden mt-4 text-gray-400 flex items-center">
                        <div class="loading-spinner mr-2"></div>
                        Summoning your image...
                    </div>
                </div>

                <div class="mt-4">
                    <h4 class="text-md font-bold mb-2 text-gray-200 theme-heading">Known <span id="skillTitleDisplay">Skills</span>:</h4>
                    <ul id="skillList" class="text-sm text-gray-300 space-y-1">
                        <!-- Skills will be rendered here -->
                    </ul>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button id="generateStoryButton" class="bg-gray-400 text-white font-bold py-3 px-6 rounded-full shadow-md cursor-not-allowed" disabled>Reveal Your Story</button>
                    <button id="viewChronicleButton" class="bg-[#00FFD1] text-black font-bold py-3 px-6 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">View Chronicle</button>
                </div>
                <p id="storyStatus" class="mt-4 text-center text-sm text-gray-400">Complete 5 tasks and wait 24 hours to generate your first story segment.</p>
                <div id="storyLoadingIndicator" class="hidden mt-4 text-gray-400 flex items-center">
                    <div class="loading-spinner mr-2"></div>
                    Unrolling the scroll...
                </div>
            </div>

            <div id="originStoryContainer" class="mt-8 p-6 bg-gray-900 rounded-lg border-2 border-gray-700 hidden">
                <h3 class="font-bold text-xl mb-4 text-center text-white theme-heading">Choose Your Origin Story</h3>
                <p class="text-center text-gray-400 mb-6">Your name, <span id="originNameDisplay" class="font-bold"></span>, holds a legend. Which path will you choose?</p>
                <div id="originChoicesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Origin stories will be dynamically added here -->
                </div>
                <div class="text-center mt-4">
                    <button id="rerollOriginButton" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">Reroll Origins</button>
                </div>
            </div>

            <div id="storyOutput" class="mt-8 p-6 bg-gray-900 rounded-lg border-2 border-gray-700 hidden">
                <!-- The generated story will be displayed here -->
            </div>
            
            <div id="choiceSystemContainer" class="mt-8 p-6 bg-gray-900 rounded-lg border-2 border-gray-700 hidden">
                <h3 class="font-bold text-xl mb-4 text-center text-white theme-heading">Choose Your Next Skill...</h3>
                <div id="choiceButtonsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Dynamic choice buttons will be added here -->
                </div>
                <div id="choiceLoadingIndicator" class="hidden mt-4 text-gray-400 flex items-center justify-center">
                    <div class="loading-spinner mr-2"></div>
                    Unfolding the outcome...
                </div>
                <div id="choiceOutcomeOutput" class="mt-4 p-4 text-white hidden">
                    <!-- The generated outcome will be displayed here -->
                </div>
                <div class="text-center mt-4 hidden" id="recordButtonContainer">
                    <button id="recordButton" class="bg-[#00FFD1] text-black font-bold py-3 px-6 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">Record Your Legend</button>
                </div>
            </div>

        </div>
    </section>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-7xl mx-auto scroll-container">
        
        <!-- Daily Tasks Section -->
        <section>
            <div id="dailyTasksPanel" class="bg-[#2b2b2b] rounded-xl shadow-lg p-6 sm:p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold theme-heading" id="dailyTasksHeading">Daily Tasks</h2>
                    <div class="flex space-x-2">
                        <button id="resetDaily" class="bg-[#FF0055] text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-opacity-80 transition-all">Reset Day</button>
                        <button id="toggleCompletedDaily" class="bg-gray-400 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-opacity-80 transition-all">Show Completed</button>
                    </div>
                </div>
                <div id="dailyTasks" class="grid grid-cols-1 md:grid-cols-1 gap-4">
                    <!-- Dynamic content or fallback message -->
                </div>
            </div>
        </section>
        
        <!-- Weekly and Monthly Tasks Sections -->
        <div class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
            <section>
                <div id="weeklyTasksPanel" class="bg-[#2b2b2b] rounded-xl shadow-lg p-6 sm:p-8 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold theme-heading" id="weeklyTasksHeading">Weekly Tasks</h2>
                        <div class="flex space-x-2">
                            <button id="resetWeekly" class="bg-[#FF0055] text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-opacity-80 transition-all">Reset Week</button>
                            <button id="toggleCompletedWeekly" class="bg-gray-400 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-opacity-80 transition-all">Show Completed</button>
                        </div>
                    </div>
                    <div id="weeklyTasks" class="space-y-4 flex-grow">
                        <!-- Dynamic content or fallback message -->
                    </div>
                </div>
            </section>
            
            <section>
                <div id="monthlyTasksPanel" class="bg-[#2b2b2b] rounded-xl shadow-lg p-6 sm:p-8 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold theme-heading" id="monthlyTasksHeading">Monthly Tasks</h2>
                        <div class="flex space-x-2">
                            <button id="resetMonthly" class="bg-[#FF0055] text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-opacity-80 transition-all">Reset Month</button>
                            <button id="toggleCompletedMonthly" class="bg-gray-400 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-opacity-80 transition-all">Show Completed</button>
                        </div>
                    </div>
                    <div id="monthlyTasks" class="space-y-4 flex-grow">
                        <!-- Dynamic content or fallback message -->
                    </div>
                </div>
            </section>
        </div>
        
    </main>

    <!-- Skill Scrolls Section -->
    <section id="skillsPanel" class="mt-8 lg:col-span-3">
        <div class="bg-[#2b2b2b] rounded-xl shadow-lg p-6 sm:p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 id="skillSectionHeading" class="text-2xl sm:text-3xl font-bold theme-heading">Skills Scrolls</h2>
                
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="p-4 bg-gray-900 rounded-lg">
                    <h3 id="createSkillHeading" class="text-xl font-bold theme-heading mb-4">Create New Skill</h3>
                    <div id="missionEnergySummary" class="bg-gray-800 p-3 rounded-lg mb-4 text-gray-200">
                        <h4 class="text-md font-bold mb-2">Potential Energy Gains</h4>
                        <div id="missionEnergySummaryContent" class="grid grid-cols-1 lg:grid-cols-3 gap-2 text-sm text-left">
                            <!-- Mission energy stats will be rendered here -->
                        </div>
                    </div>
                    <input type="text" id="newRewardName" placeholder="New Skill to Unlock" class="w-full p-2 border-2 rounded-md focus:border-[#00FFD1] focus:outline-none mb-2 bg-gray-800 text-white">
                    <div id="newSkillCostInputs" class="grid grid-cols-2 gap-2 mb-2">
                        <!-- Energy costs inputs will be rendered here -->
                    </div>
                    <button id="addReward" class="w-full bg-[#00FFD1] text-black px-4 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-all">Add Skill</button>
                </div>
                <div class="p-4 bg-gray-900 rounded-lg">
                    <h3 id="availableScrollsHeading" class="text-xl font-bold theme-heading mb-4">Available Scrolls</h3>
                    <div id="currentEnergySummary" class="bg-gray-800 p-3 rounded-lg mb-4 text-gray-200">
                        <h4 class="md font-bold mb-2">Current Energy</h4>
                        <div id="currentEnergySummaryContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-sm text-left">
                            <!-- Current energy stats will be rendered here -->
                        </div>
                    </div>
                    <ul id="rewardsList" class="space-y-3">
                        <!-- Rewards will be rendered here -->
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Floating action buttons at the bottom right -->
    <div class="action-buttons-container">
        <!-- Add Task -->
        <button id="openManualMissionModal" class="action-button bg-[#0077B6] text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="black" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
        </button>
        <!-- AI Mission -->
        <button id="openAIMissionModal" class="action-button bg-[#00FFD1] text-black">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="black" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
        </button>
        <!-- Theme Customization -->
        <button id="openCustomizationFromMain" class="action-button bg-orange-400 text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="black" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-palette">
                <circle cx="13.5" cy="6.5" r=".5" fill="black"/>
                <circle cx="17.5" cy="10.5" r=".5" fill="black"/>
                <circle cx="8.5" cy="7.5" r=".5" fill="black"/>
                <path d="M4 13s2-2 4-2 4 2 8 2s4-2 4-2"/>
                <path d="M20 16V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14v2a2 2 0 0 1-2 2h-6"/>
            </svg>
        </button>
        <!-- Master Reset -->
        <button id="masterResetButton" class="action-button bg-[#FF0055] text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="black" viewBox="0 0 16 16">
                <path d="M8.982 1.566c-.386-.198-.824-.108-.638.501L1.722 3.834.98 6.705c-.372-.345-.118-.946.336-.913l4.582.658L8.275.483c.197-.408.799-.408.995 0l2.31 4.767 4.582-.658c.454-.033.708.568.336.913l-3.232 3.55 1.722 3.834c.186.393-.252.699-.638.501L8 13.528l-4.388 1.915z"/>
            </svg>
        </button>
    </div>
    
    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content max-w-xl text-white">
            <h3 id="tutorialTitle" class="text-2xl font-bold mb-4 text-center theme-heading">Tutorial</h3>
            <p id="tutorialText" class="text-sm text-gray-300 mb-4"></p>
            <div class="flex justify-between">
                <button id="prevTutorial" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 transition-all">Previous</button>
                <button id="nextTutorial" class="bg-[#00FFD1] text-black px-4 py-2 rounded-lg font-semibold hover:bg-opacity-80 transition-all active:scale-95">Next</button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content text-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold theme-heading">Message</h3>
                <button id="closeMessage" class="text-gray-400 text-2xl hover:text-red-500">&times;</button>
            </div>
            <p id="messageText" class="text-center text-gray-300 mb-6"></p>
            <button onclick="document.getElementById('messageModal').style.display = 'none';" class="w-full bg-[#00FFD1] text-black px-4 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-all active:scale-95">OK</button>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content text-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="confirmationTitle" class="text-2xl font-bold theme-heading">Confirm Action</h3>
                <button onclick="document.getElementById('confirmationModal').style.display = 'none';" class="text-gray-400 text-2xl hover:text-red-500">&times;</button>
            </div>
            <p id="confirmationMessage" class="text-center text-gray-300 mb-6"></p>
            <div id="skillCostDisplay" class="text-sm text-gray-300 mb-4"></div>
            <div class="flex space-x-4 justify-center">
                <button id="confirmAction" class="bg-[#FF0055] text-white px-4 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-all active:scale-95">Confirm</button>
                <button id="cancelAction" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 transition-all">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Skill Info Modal -->
    
    <!-- Image Modal for full-screen view -->
    <div id="imageModal" class="fullscreen-image-modal">
        <div class="relative max-w-[90%] max-h-[90%]">
            <img id="enlargedImage" class="fullscreen-image" src="" alt="Enlarged Player Image">
            <button id="saveImageButton" class="absolute bottom-4 right-4 bg-[#00FFD1] text-black font-bold py-2 px-4 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">Save Image</button>
        </div>
        <button id="closeImageModal" class="absolute top-4 right-4 text-gray-200 text-4xl hover:text-red-500 font-bold">&times;</button>
    </div>
    
    <!-- Character Description Modal -->
    <div id="descriptionModal" class="modal">
        <div class="modal-content text-white">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold theme-heading">Edit Character Description</h3>
                <button id="closeDescriptionModal" class="text-gray-400 text-2xl hover:text-red-500">&times;</button>
            </div>
            <textarea id="characterDescriptionTextarea" class="w-full p-4 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] transition-colors bg-gray-900 text-white" rows="5" placeholder="Describe your character and their personality to bring them to life..."></textarea>
            <div class="flex space-x-4 justify-center mt-4">
                <button id="saveDescriptionButton" class="bg-[#00FFD1] text-black font-bold py-2 px-4 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">Save</button>
                <button id="cancelDescriptionButton" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-gray-500 transition-all active:scale-95">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Theme Customization Modal -->
    <div id="customizationModal" class="modal">
        <div class="modal-content text-white max-w-xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold theme-heading">Customize Your Experience</h3>
                <button id="closeCustomizationModal" class="text-gray-400 text-2xl hover:text-red-500">&times;</button>
            </div>
            <div class="border-b border-gray-700 mb-4">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="themeGeneratorTab" class="py-2 px-1 text-center font-medium text-sm text-gray-400 hover:text-gray-200 border-b-2 border-transparent hover:border-gray-500">AI Generator</button>
                    <button id="manualCustomizationTab" class="py-2 px-1 text-center font-medium text-sm text-gray-400 hover:text-gray-200 border-b-2 border-transparent hover:border-gray-500">Manual</button>
                </nav>
            </div>
            <div id="themeGeneratorContent">
                <p class="text-center text-gray-300 mb-6 max-w-2xl mx-auto">Enter the name of a fictional universe or theme you love, and I'll establish a link to that world. For example: "a fantasy realm," "a futuristic city," or "a detective story."</p>
                <div class="flex flex-col items-center space-y-4">
                    <input type="text" id="universeInput" placeholder="e.g. fantasy realm, futuristic city, etc." class="w-full p-4 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] transition-colors bg-gray-900 text-white">
                    <button id="generateThemeButton" class="w-full bg-[#00FFD1] text-black font-bold py-3 px-6 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">Generate Theme</button>
                    <div id="themeLoadingIndicator" class="hidden mt-4 text-gray-400 flex items-center">
                        <div class="loading-spinner mr-2"></div>
                        Unleashing the creative spirit...
                    </div>
                </div>
            </div>
            <div id="customizationContent" class="hidden">
                <p class="text-center text-gray-300 mb-6 max-w-2xl mx-auto">You can manually edit the theme here. Be sure to save your changes to apply them. **The values you provide here are essential for the AI to generate accurate stories about your character. For the most immersive experience, ensure your details are as specific as possible.**</p>
                <div class="space-y-4">
                    <div class="flex items-center space-x-2">
                        <label for="customAppTitle" class="text-sm font-bold w-1/4">App Name:</label>
                        <input type="text" id="customAppTitle" placeholder="e.g., The Canduit" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customPlayerTitle" class="text-sm font-bold w-1/4">Player Title:</label>
                        <input type="text" id="customPlayerTitle" placeholder="e.g., Player, Hero, Shinobi" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customMasterTitle" class="text-sm font-bold w-1/4">AI Title:</label>
                        <input type="text" id="customMasterTitle" placeholder="e.g., Master, Sensei, Oracle" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customSkillSectionTitle" class="text-sm font-bold w-1/4">Skills Title:</label>
                        <input type="text" id="customSkillSectionTitle" placeholder="e.g., Skills, Jutsu, Quirks" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customTaskTitle" class="text-sm font-bold w-1/4">Task Title:</label>
                        <input type="text" id="customTaskTitle" placeholder="e.g., Task, Mission, Quest" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customGroupTitle" class="text-sm font-bold w-1/4">Group Title:</label>
                        <input type="text" id="customGroupTitle" placeholder="e.g., Clan, House, Faction" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customSpecialityTitle" class="text-sm font-bold w-1/4">Specialty Title:</label>
                        <input type="text" id="customSpecialityTitle" placeholder="e.g., Element, Discipline, Hobby" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customRanks" class="text-sm font-bold w-1/4">Ranks (comma-separated):</label>
                        <input type="text" id="customRanks" placeholder="e.g., Novice, Apprentice, Journeyman, Master" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customEnergyTypes" class="text-sm font-bold w-1/4">Energy Types (comma-separated):</label>
                        <input type="text" id="customEnergyTypes" placeholder="e.g., Energy 1, Stamina, Chakra, Mana" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customHomeNames" class="text-sm font-bold w-1/4">Homes (comma-separated):</label>
                        <input type="text" id="customHomeNames" placeholder="e.g., Hometown, The City, The Mountains" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customBackgroundUrl" class="text-sm font-bold w-1/4">Background Image URL:</label>
                        <input type="text" id="customBackgroundUrl" placeholder="URL of your world's landscape" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="customThemeColor" class="text-sm font-bold w-1/4">Theme Color (hex):</label>
                        <input type="text" id="customThemeColor" placeholder="e.g., #00FFD1" class="w-full p-2 rounded-md bg-gray-800 text-white">
                    </div>
                </div>
                <div class="flex space-x-4 justify-center mt-4">
                    <button id="saveCustomizationButton" class="bg-[#00FFD1] text-black font-bold py-2 px-4 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">Save Theme</button>
                    <button id="cancelCustomizationButton" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-gray-500 transition-all active:scale-95">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mission Management Modal -->
    <div id="missionModal" class="modal">
        <div class="modal-content max-w-xl text-white">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold theme-heading" id="missionModalTitle">Manage Missions</h3>
                <button id="closeMissionModal" class="text-gray-400 text-2xl hover:text-red-500">&times;</button>
            </div>

            <div class="border-b border-gray-700 mb-4">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="aiTab" class="py-2 px-1 text-center font-medium text-sm text-gray-400 hover:text-gray-200 border-b-2 border-transparent hover:border-gray-500">AI Master</button>
                    <button id="manualTab" class="py-2 px-1 text-center font-medium text-sm text-gray-400 hover:text-gray-200 border-b-2 border-transparent hover:border-gray-500">Add Mission</button>
                </nav>
            </div>
            
            <div id="aiMissionContent">
                <p class="text-center text-gray-300 mb-6 max-w-2xl mx-auto">What are your goals, dreams, and aspirations? Tell the Master, and a special mission will be generated to guide you.</p>
                <div class="flex flex-col items-center space-y-4">
                    <textarea id="goalInput" class="w-full max-w-xl p-4 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] transition-colors bg-gray-900 text-white" rows="3" placeholder="Example: Become a debt-free homeowner"></textarea>
                    <button id="generateMissionsButton" class="w-full max-w-xl bg-[#00FFD1] text-black font-bold py-3 px-6 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">Generate Tasks Plan</button>
                    <div id="loadingIndicator" class="hidden mt-4 text-gray-400 flex items-center">
                        <div class="loading-spinner mr-2"></div>
                        Generating your tasks...
                    </div>
                </div>
            </div>

            <div id="manualMissionContent" class="hidden">
                <div class="flex flex-col items-center space-y-4">
                    <input type="text" id="manualMissionName" placeholder="Task Name" class="w-full p-4 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] transition-colors bg-gray-900 text-white">
                    <textarea id="manualMissionDescription" placeholder="Short Task Description" class="w-full p-4 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] transition-colors bg-gray-900 text-white" rows="2"></textarea>
                    <div class="w-full grid grid-cols-2 gap-4">
                        <select id="manualMissionFrequency" class="w-full p-3 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] bg-gray-900 text-white">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                        <select id="manualMissionFocus" class="w-full p-3 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] bg-gray-900 text-white">
                            <option value="Energy 1">Energy 1</option>
                            <option value="Energy 2">Energy 2</option>
                            <option value="Energy 3">Energy 3</option>
                            <option value="Energy 4">Energy 4</option>
                            <option value="Energy 5">Energy 5</option>
                           </select>
                    </div>
                    <input type="number" id="manualMissionPoints" placeholder="Energy Points" class="w-full p-4 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] transition-colors bg-gray-900 text-white">
                    <button id="addManualMissionButton" class="w-full bg-[#00FFD1] text-black px-4 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-all active:scale-95">Add Task</button>
                   </div>
            </div>
        </div>
    </div>

    <!-- Naming Modal -->
    <div id="namingModal" class="modal">
        <div class="modal-content text-white max-w-xl">
            <h3 class="text-2xl font-bold mb-4 text-center theme-heading">Begin Your Journey</h3>
            <p class="text-center text-gray-300 mb-6">Enter your name, pronouns, and a brief description to create your unique Player.</p>
            
            <!-- Input section for name and pronouns -->
            <div class="flex flex-col items-center space-y-4 mb-6">
                <input type="text" id="startupNameInput" class="w-full p-4 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] transition-colors bg-gray-900 text-white" placeholder="Enter your Player name">
                <div class="w-full p-4 rounded-lg border-2 border-gray-700 bg-gray-900">
                    <label for="pronounSelect" class="block text-center text-gray-300 mb-2">Select Your Pronouns</label>
                    <select id="pronounSelect" class="w-full p-2 rounded-md bg-gray-800 text-white focus:outline-none focus:border-[#00FFD1]">
                        <option value="he/him">He/Him</option>
                        <option value="she/her">She/Her</option>
                        <option value="they/them">They/Them</option>
                    </select>
                </div>
            </div>

            <!-- Optional: Upload background image -->
            <div class="w-full p-4 mb-4 rounded-lg border-2 border-gray-700 bg-gray-900 text-center">
                <p class="text-sm font-bold mb-2">Project a new reality. What does your world look like?</p>
                <label for="modalBackgroundUploadInput" class="bg-gray-800 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-all active:scale-95 shadow-md">
                    <span class="text-base">Upload Image</span>
                </label>
                <input type="file" id="modalBackgroundUploadInput" class="hidden" accept="image/*">
            </div>

            <!-- Optional: Character description -->
            <div class="w-full p-4 mb-4 rounded-lg border-2 border-gray-700 bg-gray-900 text-center">
                <p class="text-sm font-bold mb-2">Add a character description:</p>
                <textarea id="modalCharacterDescriptionTextarea" class="w-full p-2 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-[#00FFD1] transition-colors bg-gray-800 text-white" rows="3" placeholder="Describe your character and their personality..."></textarea>
            </div>
            
            <button id="submitNameButton" class="w-full bg-[#FF0055] text-white font-bold py-3 px-6 rounded-full shadow-md hover:bg-opacity-90 transition-all active:scale-95">Begin Your Journey</button>
        </div>
    </div>

    <!-- Chronicle Modal - Now a dedicated modal -->
    <div id="chronicleModal" class="modal">
        <div class="modal-content text-white max-w-xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold theme-heading">Your Chronicle</h3>
                <button id="closeChronicleModalButton" class="text-gray-400 text-2xl hover:text-red-500">&times;</button>
            </div>
            <div id="chronicleContent" class="space-y-6 overflow-y-auto max-h-[70vh]">
                <!-- The full chronicle will be displayed here -->
            </div>
        </div>
    </div>
    
    <script>
        const DAILY_RESET_HOUR = 2;
        const ARC_LENGTH = 10;
        const MIN_MISSIONS_FOR_STORY = 5;

        // Default tasks for a new user, if they don't generate them with AI
        const defaultTasks = [
            { name: 'Meditate for 10 minutes', description: 'Center yourself and focus on your breath.', frequency: 'daily', focus: 'Energy 1', points: 10 },
            { name: 'Read a chapter of a book', description: 'Expand your knowledge and explore new worlds.', frequency: 'daily', focus: 'Energy 2', points: 10 },
            { name: 'Complete your daily workout', description: 'Strengthen your body and mind.', frequency: 'daily', focus: 'Energy 3', points: 10 },
            { name: 'Plan your day', description: 'Organize your schedule and set your intentions.', frequency: 'daily', focus: 'Energy 4', points: 10 },
            { name: 'Write in your journal', description: 'Reflect on your thoughts and emotions.', frequency: 'daily', focus: 'Energy 5', points: 10 },
            { name: 'Clean your living space', description: 'Create a clean and peaceful environment.', frequency: 'weekly', focus: 'Energy 1', points: 50 },
            { name: 'Learn a new recipe', description: 'Experiment with new flavors and culinary skills.', frequency: 'weekly', focus: 'Energy 2', points: 50 },
            { name: 'Explore a new trail or park', description: 'Connect with nature and discover new places.', frequency: 'weekly', focus: 'Energy 3', points: 50 },
            { name: 'Review your weekly goals', description: 'Track your progress and adjust your plans.', frequency: 'weekly', focus: 'Energy 4', points: 50 },
            { name: 'Practice a new creative hobby', description: 'Express yourself through art, music, or writing.', frequency: 'weekly', focus: 'Energy 5', points: 50 },
            { name: 'Declutter your digital life', description: 'Organize files and unsubscribe from unnecessary emails.', frequency: 'monthly', focus: 'Energy 1', points: 200 },
            { name: 'Start a new online course', description: 'Commit to long-term learning and personal growth.', frequency: 'monthly', focus: 'Energy 2', points: 200 },
            { name: 'Take a weekend trip', description: 'Rest, recharge, and gain new perspectives.', frequency: 'monthly', focus: 'Energy 3', points: 200 },
            { name: 'Create a budget and financial plan', description: 'Manage your finances and plan for the future.', frequency: 'monthly', focus: 'Energy 4', points: 200 },
            { name: 'Complete a large creative project', description: 'Bring a major idea to life.', frequency: 'monthly', focus: 'Energy 5', points: 200 }
        ];

        const focusColors = {
            'Energy 1': '#FF0055',
            'Energy 2': '#00FFD1',
            'Energy 3': '#4CAF50',
            'Energy 4': '#FFD166',
            'Energy 5': '#6A0572'
        };
        
        const defaultCustomizableTerms = {
            appTitle: 'The Canduit',
            playerTitle: 'Player',
            masterTitle: 'Master',
            skillSectionTitle: 'Skills',
            createSkillHeading: 'Create New Skill',
            availableScrollsHeading: 'Available Scrolls',
            taskTitle: 'Task',
            ranks: ['Novice', 'Apprentice', 'Journeyman', 'Master'],
            energyTypes: ['Energy 1', 'Energy 2', 'Energy 3', 'Energy 4', 'Energy 5'],
            homeNames: ['Hometown', 'The City', 'The Mountains', 'The Coast', 'The Kingdom'],
            groupTitle: 'Clan',
            specialityTitle: 'Specialty',
            universe: 'Fantasy',
            backgroundUrl: '',
            themeColor: '#00FFD1'
        };

        let customizableTerms = JSON.parse(localStorage.getItem('customizableTerms')) || defaultCustomizableTerms;

        const fontMap = {
            'Fantasy': { name: 'Metal Mania', url: 'https://fonts.googleapis.com/css2?family=Metal+Mania&display=swap' },
            'Cyberpunk': { name: 'Share Tech Mono', url: 'https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap' },
            'Sci-Fi': { name: 'Orbitron', url: 'https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap' },
            'Medieval': { name: 'MedievalSharp', url: 'https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap' },
            'Sitcom': { name: 'Comic Neue', url: 'https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap' },
            'Anime': { name: 'Press Start 2P', url: 'https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap' },
            'Horror': { name: 'Creepster', url: 'https://fonts.googleapis.com/css2?family=Creepster&display=swap' },
            'Thriller': { name: 'Cutive Mono', url: 'https://fonts.googleapis.com/css2?family=Cutive+Mono&display=swap' }
        };

        // Initialize state variables from local storage, with fallbacks
        let energy = JSON.parse(localStorage.getItem('energy')) || { total: 0, 'Energy 1': 0, 'Energy 2': 0, 'Energy 3': 0, 'Energy 4': 0, 'Energy 5': 0 };
        let lifetimeEnergy = JSON.parse(localStorage.getItem('lifetimeEnergy')) || 0;
        let completedTasks = JSON.parse(localStorage.getItem('completedTasks')) || {};
        let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
        let missionsCompletedSinceLastStory = JSON.parse(localStorage.getItem('missionsCompletedSinceLastStory')) || 0;
        let lastStoryTime = JSON.parse(localStorage.getItem('lastStoryTime')) || 0;
        let characterName = localStorage.getItem('characterName') || '';
        let playerPronouns = localStorage.getItem('playerPronouns') || 'they/them';
        let playerChronicle = JSON.parse(localStorage.getItem('playerChronicle')) || [];
        let playerImage = localStorage.getItem('playerImage') || '';
        let characterDescription = localStorage.getItem('characterDescription') || '';
        let allTasks = JSON.parse(localStorage.getItem('allTasks')) || [];
        let lastDailyReset = localStorage.getItem('lastDailyReset') || new Date(0).toISOString();
        let playerRank = localStorage.getItem('playerRank') || customizableTerms.ranks[0];
        let isPromotionArc = JSON.parse(localStorage.getItem('isPromotionArc')) || false;
        let knownSkills = JSON.parse(localStorage.getItem('knownSkills')) || [];
        let characterBio = JSON.parse(localStorage.getItem('characterBio')) || null;
        let retiredChronicles = JSON.parse(localStorage.getItem('retiredChronicles')) || [];
        let lastImageTime = JSON.parse(localStorage.getItem('lastImageTime')) || 0;
        let themeChosen = localStorage.getItem('themeChosen') === 'true';
        
        let currentArc = parseInt(localStorage.getItem('currentArc')) || 1;
        let currentChapterInArc = parseInt(localStorage.getItem('currentChapterInArc')) || 1;

        let temporaryStorySegment = '';
        let temporaryChoice = '';
        let temporaryOutcome = '';
        
        const RANK_THRESHOLDS = {
            [customizableTerms.ranks[1]]: 500,
            [customizableTerms.ranks[2]]: 2000,
            [customizableTerms.ranks[3]]: 5000
        };
        
        let showCompletedDaily = false;
        let showCompletedWeekly = false;
        let showCompletedMonthly = false;

        /**
         * Saves the current application state to local storage.
         */
        const saveState = () => {
            localStorage.setItem('energy', JSON.stringify(energy));
            localStorage.setItem('lifetimeEnergy', JSON.stringify(lifetimeEnergy));
            localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
            localStorage.setItem('rewards', JSON.stringify(rewards));
            localStorage.setItem('missionsCompletedSinceLastStory', JSON.stringify(missionsCompletedSinceLastStory));
            localStorage.setItem('lastStoryTime', JSON.stringify(lastStoryTime));
            localStorage.setItem('characterName', characterName);
            localStorage.setItem('playerPronouns', playerPronouns);
            localStorage.setItem('playerChronicle', JSON.stringify(playerChronicle));
            localStorage.setItem('playerImage', playerImage);
            localStorage.setItem('characterDescription', characterDescription);
            localStorage.setItem('allTasks', JSON.stringify(allTasks));
            localStorage.setItem('lastDailyReset', lastDailyReset);
            localStorage.setItem('playerRank', playerRank);
            localStorage.setItem('isPromotionArc', JSON.stringify(isPromotionArc));
            localStorage.setItem('knownSkills', JSON.stringify(knownSkills));
            localStorage.setItem('characterBio', JSON.stringify(characterBio));
            localStorage.setItem('retiredChronicles', JSON.stringify(retiredChronicles));
            localStorage.setItem('currentArc', JSON.stringify(currentArc));
            localStorage.setItem('currentChapterInArc', JSON.stringify(currentChapterInArc));
            localStorage.setItem('lastImageTime', JSON.stringify(lastImageTime));
            localStorage.setItem('customizableTerms', JSON.stringify(customizableTerms));
            localStorage.setItem('themeChosen', themeChosen);


            updatePointsDisplay();
            updateStoryStatus();
            updateRankAndSkillDisplay();
            renderEnergySummary();
            updateImageGeneratorStatus();
        };

        /**
         * Updates the total energy display on the main page.
         */
        const updatePointsDisplay = () => {
            const totalPointsDisplay = document.getElementById('totalPointsDisplay');
            if (totalPointsDisplay) {
                totalPointsDisplay.textContent = lifetimeEnergy;
            }
        };

        /**
         * Renders the energy summary panels showing potential gains and current energy.
         */
        const renderEnergySummary = () => {
            const missionEnergySummaryContent = document.getElementById('missionEnergySummaryContent');
            if (missionEnergySummaryContent) {
                missionEnergySummaryContent.innerHTML = '';
                const dailyGains = {};
                const weeklyGains = {};
                const monthlyGains = {};
                customizableTerms.energyTypes.forEach(type => {
                    dailyGains[type] = 0;
                    weeklyGains[type] = 0;
                    monthlyGains[type] = 0;
                });
                
                allTasks.forEach(task => {
                    if (task.frequency === 'daily') dailyGains[task.focus] += task.points;
                    if (task.frequency === 'weekly') weeklyGains[task.focus] += task.points;
                    if (task.frequency === 'monthly') monthlyGains[task.focus] += task.points;
                });

                const renderGains = (gains, label) => {
                    const total = Object.values(gains).reduce((sum, value) => sum + value, 0);
                    const item = document.createElement('div');
                    item.className = 'energy-summary-item bg-gray-800 p-2 rounded-md';
                    item.innerHTML = `<p class="capitalize font-bold text-sm">${label} Gains: <span class="text-sm font-bold">${total}</span></p>`;
                    Object.entries(gains).forEach(([type, value]) => {
                        if (value > 0) {
                            item.innerHTML += `<p class="text-xs text-gray-400 capitalize ml-2">${type}: +${value}</p>`;
                        }
                    });
                    missionEnergySummaryContent.appendChild(item);
                };
                
                renderGains(dailyGains, 'Daily');
                renderGains(weeklyGains, 'Weekly');
                renderGains(monthlyGains, 'Monthly');
            }

            const currentEnergySummaryContent = document.getElementById('currentEnergySummaryContent');
            if (currentEnergySummaryContent) {
                currentEnergySummaryContent.innerHTML = '';
                for (const type of customizableTerms.energyTypes) {
                    const item = document.createElement('div');
                    item.className = 'energy-summary-item bg-gray-800 p-2 rounded-md';
                    item.innerHTML = `
                        <p class="capitalize font-bold text-sm">${type}</p>
                        <p>Current: <span class="font-bold">${energy[type]}</span></p>
                    `;
                    currentEnergySummaryContent.appendChild(item);
                }
            }
        };

        /**
         * Updates the player's rank and known skills display.
         */
        const updateRankAndSkillDisplay = () => {
            if (document.getElementById('playerRankDisplay')) {
                document.getElementById('playerRankDisplay').textContent = playerRank;
            }
            const skillListEl = document.getElementById('skillList');
            if (skillListEl) {
                skillListEl.innerHTML = '';
                if (knownSkills.length === 0) {
                    skillListEl.innerHTML = `<li class="text-gray-400">No ${customizableTerms.skillSectionTitle} learned yet.</li>`;
                } else {
                    knownSkills.forEach(skill => {
                        const li = document.createElement('li');
                        li.textContent = ` ${skill}`;
                        skillListEl.appendChild(li);
                    });
                }
            }
            const arcIndicatorDisplay = document.getElementById('arcIndicatorDisplay');
            if (arcIndicatorDisplay) {
                arcIndicatorDisplay.textContent = `Arc ${currentArc}, Chapter ${currentChapterInArc}/${ARC_LENGTH}`;
            }
        };

        /**
         * Renders tasks based on their frequency (daily, weekly, monthly).
         * @param {string} frequency - The frequency of tasks to render.
         */
        const renderTasks = (frequency) => {
            const container = document.getElementById(`${frequency}Tasks`);
            if (!container) return;
            container.innerHTML = '';
            
            const tasksToRender = allTasks.filter(task => task.frequency === frequency);
            if (tasksToRender.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 p-6 border border-gray-700 rounded-lg">
                        <p class="mb-4">No tasks found for this period. How about you create some?</p>
                        <button onclick="document.getElementById('openAIMissionModal').click()" class="bg-[#00FFD1] text-black px-4 py-2 rounded-full font-bold text-sm hover:bg-opacity-90 transition-all active:scale-95">Use AI Mission Maker</button>
                    </div>
                `;
            } else {
                tasksToRender.forEach(task => {
                    const isCompleted = completedTasks[task.name];
                    
                    if (!isCompleted || (frequency === 'daily' && showCompletedDaily) || (frequency === 'weekly' && showCompletedWeekly) || (frequency === 'monthly' && showCompletedMonthly)) {
                        const card = document.createElement('div');
                        card.className = `task-card p-4 rounded-lg shadow-md flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 ${isCompleted ? 'bg-gray-800 completed' : 'bg-gray-900'} text-white`;
                        card.style.borderLeft = `8px solid ${focusColors[task.focus]}`;
                        
                        card.innerHTML = `
                            <div class="flex-1 min-w-0 pr-4">
                                <h4 class="font-semibold text-lg sm:text-xl cursor-pointer task-name-text" onclick="showMessageModal('${task.description.replace(/'/g, "\\'")}')">${task.name}</h4>
                                <p class="text-xs sm:text-sm text-gray-400">${task.focus}  +${task.points} Energy</p>
                            </div>
                            <div class="task-action-container">
                                <button class="task-button bg-[#00FFD1] text-black font-bold p-2 rounded-full hover:bg-opacity-90 transition-all active:scale-95 action-icon-button" data-task-name="${task.name}" data-task-focus="${task.focus}" data-task-points="${task.points}" ${isCompleted ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check">
                                        <path d="M20 6 9 17l-5-5"/>
                                    </svg>
                                </button>
                                <button class="delete-task-button text-gray-400 text-lg hover:text-red-500" data-task-name="${task.name}">&times;</button>
                            </div>
                        `;
                        container.appendChild(card);
                    }
                });
            }
        };

        /**
         * Renders the list of available rewards (skills).
         */
        const renderRewards = () => {
            const list = document.getElementById('rewardsList');
            if (!list) return;
            list.innerHTML = '';
            rewards.forEach((reward, index) => {
                const item = document.createElement('li');
                item.className = 'flex items-center justify-between bg-gray-900 p-3 rounded-md shadow-sm text-white';
                let costString = '';
                for (const [key, value] of Object.entries(reward.cost)) {
                    if (value > 0) {
                        costString += `${value} ${key}, `;
                    }
                }
                costString = costString.slice(0, -2);
                item.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium">${reward.name}</span>
                        <span class="ml-2 text-sm text-gray-400">(${costString})</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="redeem-reward-button bg-[#00FFD1] text-black px-3 py-1 rounded-lg font-semibold text-sm hover:bg-opacity90 transition-all active:scale-95" data-reward-index="${index}">Use Skill</button>
                        <button class="delete-reward-button text-gray-400 text-lg hover:text-red-500" data-reward-index="${index}">&times;</button>
                    </div>
                `;
                list.appendChild(item);
            });
        };

        /**
         * Displays a confirmation modal with a custom message and callback.
         * @param {string} title - The modal title.
         * @param {string} message - The modal message.
         * @param {object|null} costs - An optional object of costs to display.
         * @param {Function} callback - The function to execute on confirmation.
         */
        const showConfirmationModal = (title, message, costs, callback) => {
            const modal = document.getElementById('confirmationModal');
            if (!modal) return;
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            const costDisplay = document.getElementById('skillCostDisplay');
            costDisplay.innerHTML = '';
            if (costs) {
                const costHeading = document.createElement('p');
                costHeading.className = 'font-bold';
                costHeading.textContent = `Energy Cost:`;
                costDisplay.appendChild(costHeading);
                const ul = document.createElement('ul');
                for (const [type, amount] of Object.entries(costs)) {
                    if (amount > 0) {
                        const li = document.createElement('li');
                        li.textContent = `- ${type}: ${amount}`;
                        ul.appendChild(li);
                    }
                }
                costDisplay.appendChild(ul);
            }
            modal.style.display = 'flex';
            const confirmActionBtn = document.getElementById('confirmAction');
            if (confirmActionBtn) confirmActionBtn.onclick = () => {
                callback();
                modal.style.display = 'none';
            };
            const cancelActionBtn = document.getElementById('cancelAction');
            if (cancelActionBtn) cancelActionBtn.onclick = () => {
                modal.style.display = 'none';
            };
        };

        /**
         * Displays a simple message modal with a custom message.
         * @param {string} message - The message to display.
         */
        const showMessageModal = (message) => {
            const modal = document.getElementById('messageModal');
            if (!modal) return;
            document.getElementById('messageText').textContent = message;
            modal.style.display = 'flex';
        };
        const closeMessageButton = document.getElementById('closeMessage');
        if (closeMessageButton) closeMessageButton.addEventListener('click', () => {
            document.getElementById('messageModal').style.display = 'none';
        });

        document.addEventListener('click', (e) => {
            if (e.target.closest('.task-button')) {
                const button = e.target.closest('.task-button');
                const taskName = button.dataset.taskName;
                const taskFocus = button.dataset.taskFocus;
                const taskPoints = parseInt(button.dataset.taskPoints, 10);
                if (taskName && !completedTasks[taskName]) { 
                    energy[taskFocus] += taskPoints;
                    energy.total += taskPoints;
                    lifetimeEnergy += taskPoints;
                    completedTasks[taskName] = true;
                    button.disabled = true;
                    button.closest('.task-card').classList.add('completed');
                    missionsCompletedSinceLastStory++;
                    saveState();
                }
            }
            if (e.target.classList.contains('redeem-reward-button')) {
                const rewardIndex = parseInt(e.target.dataset.rewardIndex, 10);
                const reward = rewards[rewardIndex];

                let canAfford = true;
                for (const [type, amount] of Object.entries(reward.cost)) {
                    if (energy[type] < amount) {
                        canAfford = false;
                        break;
                    }
                }

                if (canAfford) {
                    showConfirmationModal(
                        `Use "${reward.name}" Skill?`,
                        `This will deduct the required energy from your total. Do you want to proceed?`,
                        reward.cost,
                        () => {
                            for (const [type, amount] of Object.entries(reward.cost)) {
                                energy[type] -= amount;
                            }
                            energy.total = Object.values(energy).reduce((sum, value) => typeof value === 'number' && value !== energy.total ? sum + value : sum, 0);
                            saveState();
                            showMessageModal(`The "${reward.name}" skill has been used!`);
                        }
                    );
                } else {
                    showMessageModal("You do not have enough Energy to use this Skill!");
                }
            }
            if (e.target.classList.contains('delete-reward-button')) {
                const rewardIndex = parseInt(e.target.dataset.rewardIndex, 10);
                showConfirmationModal(
                    `Delete "${rewards[rewardIndex].name}"?`,
                    `Are you sure you want to permanently delete this skill scroll? This cannot be undone.`,
                    null,
                    () => {
                        rewards.splice(rewardIndex, 1);
                        saveState();
                        renderRewards();
                    }
                );
            }
            if (e.target.classList.contains('delete-task-button')) {
                const taskName = e.target.dataset.taskName;
                const taskToDelete = allTasks.find(task => task.name === taskName);
                if (taskToDelete) {
                    showConfirmationModal(
                        `Delete "${taskName}"?`,
                        `Are you sure you want to permanently delete this task? This cannot be undone.`,
                        null,
                        () => {
                            allTasks = allTasks.filter(task => task.name !== taskName);
                            delete completedTasks[taskName];
                            saveState();
                            renderTasks('daily');
                            renderTasks('weekly');
                            renderTasks('monthly');
                        }
                    );
                }
            }
            if (e.target.id === 'rerollOriginButton') {
                const nameFromStorage = localStorage.getItem('characterName');
                if (nameFromStorage) {
                    generateOriginStory(nameFromStorage);
                }
            }
            if (e.target.classList.contains('select-origin-button')) {
                const origins = JSON.parse(e.target.closest('#originStoryContainer').dataset.origins);
                const selectedIndex = parseInt(e.target.dataset.storyIndex);
                recordOriginStory(origins[selectedIndex]);
            }
            if (e.target.id === 'openManualMissionModal') {
                const missionModal = document.getElementById('missionModal');
                if (missionModal) {
                    document.getElementById('missionModalTitle').textContent = `Add Custom ${customizableTerms.taskTitle}s`;
                    document.getElementById('manualMissionFocus').innerHTML = customizableTerms.energyTypes.map(type => `<option value="${type}">${type}</option>`).join('');
                    missionModal.style.display = 'flex';
                }
                const manualTab = document.getElementById('manualTab');
                if (manualTab) {
                    manualTab.classList.add('border-[#00FFD1]', 'text-white');
                    const aiTab = document.getElementById('aiTab');
                    if (aiTab) aiTab.classList.remove('border-[#00FFD1]', 'text-white');
                }
                const manualMissionContent = document.getElementById('manualMissionContent');
                if (manualMissionContent) manualMissionContent.classList.remove('hidden');
                const aiMissionContent = document.getElementById('aiMissionContent');
                if (aiMissionContent) aiMissionContent.classList.add('hidden');
            }
            if (e.target.id === 'openAIMissionModal') {
                const missionModal = document.getElementById('missionModal');
                if (missionModal) {
                    document.getElementById('missionModalTitle').textContent = `AI ${customizableTerms.masterTitle}`;
                    document.getElementById('manualMissionFocus').innerHTML = customizableTerms.energyTypes.map(type => `<option value="${type}">${type}</option>`).join('');
                    missionModal.style.display = 'flex';
                }
                const aiTab = document.getElementById('aiTab');
                if (aiTab) {
                    aiTab.classList.add('border-[#00FFD1]', 'text-white');
                    const manualTab = document.getElementById('manualTab');
                    if (manualTab) manualTab.classList.remove('border-[#00FFD1]', 'text-white');
                }
                const aiMissionContent = document.getElementById('aiMissionContent');
                if (aiMissionContent) aiMissionContent.classList.remove('hidden');
                const manualMissionContent = document.getElementById('manualMissionContent');
                if (manualMissionContent) manualMissionContent.classList.add('hidden');
            }
            if (e.target.id === 'closeMissionModal') {
                document.getElementById('missionModal').style.display = 'none';
            }
            if (e.target.id === 'aiTab') {
                document.getElementById('aiTab').classList.add('border-[#00FFD1]', 'text-white');
                document.getElementById('manualTab').classList.remove('border-[#00FFD1]', 'text-white');
                document.getElementById('aiMissionContent').classList.remove('hidden');
                document.getElementById('manualMissionContent').classList.add('hidden');
            }
            if (e.target.id === 'manualTab') {
                document.getElementById('manualTab').classList.add('border-[#00FFD1]', 'text-white');
                document.getElementById('aiTab').classList.remove('border-[#00FFD1]', 'text-white');
                document.getElementById('manualMissionContent').classList.remove('hidden');
                document.getElementById('aiMissionContent').classList.add('hidden');
            }
            if (e.target.id === 'toggleCompletedDaily') {
                showCompletedDaily = !showCompletedDaily;
                renderTasks('daily');
                e.target.textContent = showCompletedDaily ? 'Hide Completed' : 'Show Completed';
            }
            if (e.target.id === 'toggleCompletedWeekly') {
                showCompletedWeekly = !showCompletedWeekly;
                renderTasks('weekly');
                e.target.textContent = showCompletedWeekly ? 'Hide Completed' : 'Show Completed';
            }
            if (e.target.id === 'toggleCompletedMonthly') {
                showCompletedMonthly = !showCompletedMonthly;
                renderTasks('monthly');
                e.target.textContent = showCompletedMonthly ? 'Hide Completed' : 'Show Completed';
            }
        });

        const addRewardButton = document.getElementById('addReward');
        if(addRewardButton) addRewardButton.addEventListener('click', () => {
            const nameInput = document.getElementById('newRewardName');
            const costInputs = {};
            customizableTerms.energyTypes.forEach(type => {
                costInputs[type] = document.getElementById(`newReward${type.replace(/\s/g, '')}`);
            });

            const name = nameInput.value.trim();
            const cost = {};
            customizableTerms.energyTypes.forEach(type => {
                cost[type] = parseInt(costInputs[type].value, 10) || 0;
            });

            if (name && Object.values(cost).some(c => c > 0)) {
                rewards.push({ name, cost });
                nameInput.value = '';
                Object.values(costInputs).forEach(input => input.value = '');
                renderRewards();
                saveState();
            } else {
                showMessageModal("Please provide a name and at least one energy cost greater than 0.");
            }
        });

        /**
         * Renders the input fields for creating a new skill based on the current energy types.
         */
        const renderNewSkillCostInputs = () => {
            const container = document.getElementById('newSkillCostInputs');
            if (container) {
                container.innerHTML = customizableTerms.energyTypes.map(type => `
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-bold w-1/3 text-right" style="color: ${focusColors[type]};">${type}:</label>
                        <input type="number" id="newReward${type.replace(/\s/g, '')}" placeholder="cost" class="p-1 border-2 rounded-md focus:border-[#00FFD1] focus:outline-none flex-grow bg-gray-900 text-white w-2/3">
                    </div>
                `).join('');
            }
        };

        const resetDailyButton = document.getElementById('resetDaily');
        if (resetDailyButton) resetDailyButton.addEventListener('click', () => {
            allTasks.filter(t => t.frequency === 'daily').forEach(task => {
                delete completedTasks[task.name];
            });
            saveState();
            renderTasks('daily');
        });

        const resetWeeklyButton = document.getElementById('resetWeekly');
        if (resetWeeklyButton) resetWeeklyButton.addEventListener('click', () => {
            allTasks.filter(t => t.frequency === 'weekly').forEach(task => {
                delete completedTasks[task.name];
            });
            saveState();
            renderTasks('weekly');
        });

        const resetMonthlyButton = document.getElementById('resetMonthly');
        if (resetMonthlyButton) resetMonthlyButton.addEventListener('click', () => {
            allTasks.filter(t => t.frequency === 'monthly').forEach(task => {
                delete completedTasks[task.name];
            });
            saveState();
            renderTasks('monthly');
        });

        const generateMissionsButton = document.getElementById('generateMissionsButton');
        const masterResetButton = document.getElementById('masterResetButton');
        const goalInput = document.getElementById('goalInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const openDescriptionModalButton = document.getElementById('openDescriptionModal');
        const descriptionModal = document.getElementById('descriptionModal');
        const closeDescriptionModalButton = document.getElementById('closeDescriptionModal');
        const characterDescriptionTextarea = document.getElementById('characterDescriptionTextarea');
        const saveDescriptionButton = document.getElementById('saveDescriptionButton');
        const cancelDescriptionButton = document.getElementById('cancelDescriptionButton');
        const universeInput = document.getElementById('universeInput');
        const themeLoadingIndicator = document.getElementById('themeLoadingIndicator');
        const customizationContent = document.getElementById('customizationContent');
        const themeGeneratorContent = document.getElementById('themeGeneratorContent');
        const rerollThemeButton = document.getElementById('rerollThemeButton');

        if (openDescriptionModalButton) openDescriptionModalButton.addEventListener('click', () => {
            if (descriptionModal) {
                characterDescriptionTextarea.value = characterDescription;
                descriptionModal.style.display = 'flex';
            }
        });

        if (closeDescriptionModalButton) closeDescriptionModalButton.addEventListener('click', () => {
            if (descriptionModal) descriptionModal.style.display = 'none';
        });

        if (cancelDescriptionButton) cancelDescriptionButton.addEventListener('click', () => {
            if (descriptionModal) descriptionModal.style.display = 'none';
        });
        
        if (saveDescriptionButton) saveDescriptionButton.addEventListener('click', () => {
            characterDescription = characterDescriptionTextarea.value.trim();
            saveState();
            if (descriptionModal) descriptionModal.style.display = 'none';
            // NEW BEHAVIOR: Do not automatically open the mission modal after saving the description.
            showMessageModal("Character description saved!");
        });


        /**
         * Generates a set of tasks based on a user's goal using the Gemini API.
         * @param {string} userGoal - The goal provided by the user.
         */
        const generateMissions = async (userGoal) => {
            const basePrompt = `Generate a set of gamified tasks for a user with the goal: "${userGoal}". The tasks should be specific, actionable, and categorized by frequency: 'daily', 'weekly', and 'monthly'. Each task must include a name, a focus area (${customizableTerms.energyTypes.join(', ')}), a frequency, a point value, and a short description. The point value should scale with the effort: 5-10 for daily, 20-50 for weekly, and 100-200 for monthly. The response MUST be a single JSON object with a 'missions' key, and the value must be an array of objects, with each object having the keys: 'name', 'focus', 'frequency', 'points', and 'description'. Do not include any other text or formatting outside the JSON object.`;
            
            const chatHistory = [{ role: "user", parts: [{ text: basePrompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "missions": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "name": { "type": "STRING" },
                                        "focus": { "type": "STRING", "enum": customizableTerms.energyTypes },
                                        "frequency": { "type": "STRING", "enum": ["daily", "weekly", "monthly"] },
                                        "points": { "type": "NUMBER" },
                                        "description": { "type": "STRING" }
                                    },
                                    "propertyOrdering": ["name", "focus", "frequency", "points", "description"]
                                }
                            }
                        }
                    }
                }
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let attempts = 0;
            const maxAttempts = 3;
            const baseDelay = 1000;
            let success = false;

            while(attempts < maxAttempts && !success) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        const data = JSON.parse(jsonString);
                        
                        // New logic: Add new missions instead of replacing old ones
                        const newMissions = data.missions.filter(newMission => 
                            !allTasks.some(existingMission => existingMission.name === newMission.name)
                        );

                        if (newMissions.length > 0) {
                           allTasks.push(...newMissions);
                           saveState();
                           renderTasks('daily');
                           renderTasks('weekly');
                           renderTasks('monthly');
                           showMessageModal(`New missions have been generated and added to your list! If your task list becomes too long, you can delete tasks using the '' button on each card.`);
                        } else {
                           showMessageModal("The AI couldn't generate new, unique tasks based on your goal. Try a different goal or add tasks manually.");
                        }

                        success = true;
                    } else {
                        throw new Error('No valid content in API response');
                    }
                } catch (error) {
                    console.error('Error fetching from API:', error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        const delay = baseDelay * Math.pow(2, attempts - 1) + Math.random() * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            }

            loadingIndicator.classList.add('hidden');
            if (generateMissionsButton) generateMissionsButton.disabled = false;

            if (!success) {
                showMessageModal('Failed to generate missions. Please check your network and try again.');
            } else {
                 document.getElementById('missionModal').style.display = 'none';
            }
        };

        if (generateMissionsButton) generateMissionsButton.addEventListener('click', async () => {
            const userGoal = goalInput.value.trim();
            if (!userGoal) {
                return;
            }

            loadingIndicator.classList.remove('hidden');
            generateMissionsButton.disabled = true;
            await generateMissions(userGoal);
        });

        const addManualMissionButton = document.getElementById('addManualMissionButton');
        if (addManualMissionButton) addManualMissionButton.addEventListener('click', () => {
            const name = document.getElementById('manualMissionName').value.trim();
            const description = document.getElementById('manualMissionDescription').value.trim();
            const frequency = document.getElementById('manualMissionFrequency').value;
            const focus = document.getElementById('manualMissionFocus').value;
            const points = parseInt(document.getElementById('manualMissionPoints').value, 10) || 0;

            if (!name || !description || points <= 0) {
                showMessageModal("Please fill in all fields with valid data.");
                return;
            }

            const newMission = { name, description, frequency, focus, points };
            allTasks.push(newMission);
            saveState();
            renderTasks(frequency);
            document.getElementById('missionModal').style.display = 'none';
            
            document.getElementById('manualMissionName').value = '';
            document.getElementById('manualMissionDescription').value = '';
            document.getElementById('manualMissionPoints').value = '';
            showMessageModal("Task added successfully!");
        });

        const restoreDefaultMissions = () => {
            allTasks = [...defaultTasks];
            completedTasks = {};
            saveState();
            renderTasks('daily');
            renderTasks('weekly');
            renderTasks('monthly');
            showMessageModal("The original tasks plan has been restored!");
        };

        /**
         * Resets the entire application to its default state.
         */
        const masterReset = () => {
            // Corrected bug: Instead of re-saving state, just clear local storage and reload.
            // When the page reloads, the script will automatically re-initialize all variables to their defaults.
            localStorage.clear();
            window.location.reload();
        };

        const generateStoryButton = document.getElementById('generateStoryButton');
        const storyOutput = document.getElementById('storyOutput');
        const storyLoadingIndicator = document.getElementById('storyLoadingIndicator');
        const storyStatus = document.getElementById('storyStatus');
        const viewChronicleButton = document.getElementById('viewChronicleButton');
        const chronicleModal = document.getElementById('chronicleModal');
        const chronicleContent = document.getElementById('chronicleContent');
        const closeChronicleModalButton = document.getElementById('closeChronicleModalButton');
        const playerImageInput = document.getElementById('playerImageInput');
        const playerImageDisplay = document.getElementById('playerImageDisplay');
        const choiceSystemContainer = document.getElementById('choiceSystemContainer');
        const choiceButtonsContainer = document.getElementById('choiceButtonsContainer');
        const choiceLoadingIndicator = document.getElementById('choiceLoadingIndicator');
        const choiceOutcomeOutput = document.getElementById('choiceOutcomeOutput');
        const recordButtonContainer = document.getElementById('recordButtonContainer');
        const recordButton = document.getElementById('recordButton');
        const originStoryContainer = document.getElementById('originStoryContainer');
        const originChoicesContainer = document.getElementById('originChoicesContainer');
        const originNameDisplay = document.getElementById('originNameDisplay');
        const rerollOriginButton = document.getElementById('rerollOriginButton');
        const characterNameDisplay = document.getElementById('characterNameDisplay');
        const namingModal = document.getElementById('namingModal');
        const startupNameInput = document.getElementById('startupNameInput');
        const submitNameButton = document.getElementById('submitNameButton');
        const generateImageButton = document.getElementById('generateImageButton');
        const setProfileImageButton = document.getElementById('setProfileImageButton');
        const imageGeneratorSection = document.getElementById('imageGeneratorSection');
        const imageLoadingIndicator = document.getElementById('imageLoadingIndicator');
        const imageModal = document.getElementById('imageModal');
        const enlargedImage = document.getElementById('enlargedImage');
        const modalBackgroundUploadInput = document.getElementById('modalBackgroundUploadInput');
        
        let generatedImageUrl = '';

        /**
         * Updates the status message for story generation based on progress.
         */
        const updateStoryStatus = () => {
            const today = new Date().toDateString();
            const lastStoryDate = new Date(lastStoryTime).toDateString();
            
            const missionsNeeded = MIN_MISSIONS_FOR_STORY - missionsCompletedSinceLastStory;
            let canGenerate = missionsCompletedSinceLastStory >= MIN_MISSIONS_FOR_STORY && today !== lastStoryDate;

            let statusMessage = '';
            
            // Check for the "wait 24 hours" condition first.
            if (today === lastStoryDate) {
                statusMessage = 'You have already generated a story today. Your next chapter awaits tomorrow.';
                canGenerate = false;
            } else if (playerChronicle.length === 0) {
                statusMessage = `Choose your origin story to begin.`;
                canGenerate = true;
            } else if (missionsNeeded > 0) {
                statusMessage = `Complete ${missionsNeeded} more tasks to unlock your story.`;
                canGenerate = false;
            } else {
                 statusMessage = 'You are ready to reveal your next story chapter!';
                 canGenerate = true;
            }
            
            if (generateStoryButton) {
                generateStoryButton.disabled = !canGenerate;
                generateStoryButton.classList.toggle('bg-gray-400', !canGenerate);
                generateStoryButton.classList.toggle('cursor-not-allowed', !canGenerate);
                generateStoryButton.classList.toggle('bg-[--theme-color]', canGenerate);
            
                if (!characterName) {
                    statusMessage = `Please enter your ${customizableTerms.playerTitle} name to start your journey.`;
                    generateStoryButton.disabled = true;
                    generateStoryButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                    generateStoryButton.classList.remove('bg-[--theme-color]');
                }
            }
            
            if (storyStatus) storyStatus.textContent = statusMessage;
            
            if (viewChronicleButton) {
                viewChronicleButton.disabled = playerChronicle.length === 0;
                viewChronicleButton.classList.toggle('opacity-50', playerChronicle.length === 0);
                viewChronicleButton.classList.toggle('cursor-not-allowed', playerChronicle.length === 0);
            }
        };
        
        /**
         * Updates the status of the image generator section.
         */
        const updateImageGeneratorStatus = () => {
            const today = new Date().toDateString();
            const lastStoryDate = new Date(lastStoryTime).toDateString();
            const lastImageDate = new Date(lastImageTime).toDateString();
            const hasStory = playerChronicle.length > 0;
            const hasDescription = characterDescription && characterDescription.trim() !== '';
            const canGenerateImage = hasStory && hasDescription && (lastStoryDate !== lastImageDate);

            if (imageGeneratorSection) {
                imageGeneratorSection.classList.toggle('hidden', !hasStory);
            }

            if (generateImageButton) {
                generateImageButton.disabled = !canGenerateImage;
                generateImageButton.classList.toggle('bg-gray-400', !canGenerateImage);
                generateImageButton.classList.toggle('cursor-not-allowed', !canGenerateImage);
                generateImageButton.classList.toggle('bg-[#00FFD1]', canGenerateImage);
            }
        };

        const toggleCompletedTasks = (frequency) => {
            const container = document.getElementById(`${frequency}Tasks`);
            const button = document.getElementById(`toggleCompleted${frequency.charAt(0).toUpperCase() + frequency.slice(1)}`);
            
            if (!container || !button) {
                return;
            }
            
            const hideCompleted = button.textContent === 'Hide Completed';
            
            if(hideCompleted) {
                button.textContent = 'Show Completed';
                container.querySelectorAll('.completed').forEach(card => card.style.display = 'none');
            } else {
                button.textContent = 'Hide Completed';
                container.querySelectorAll('.completed').forEach(card => card.style.display = 'flex');
            }
            
            if (frequency === 'daily') showCompletedDaily = !showCompletedDaily;
            if (frequency === 'weekly') showCompletedWeekly = !showCompletedWeekly;
            if (frequency === 'monthly') showCompletedMonthly = !showCompletedMonthly;
        };

        /**
         * Checks if the daily reset time has passed and resets daily tasks if needed.
         */
        const checkDailyReset = () => {
            const now = new Date();
            const lastResetDate = new Date(lastDailyReset);
            const today = now.toDateString();
            const resetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), DAILY_RESET_HOUR, 0, 0);

            if (lastResetDate.toDateString() !== today && now >= resetTime) {
                allTasks.filter(t => t.frequency === 'daily').forEach(task => {
                    delete completedTasks[task.name];
                });
                lastDailyReset = now.toISOString();
                saveState();
                renderTasks('daily');
            }
        };

        /**
         * Checks if the player is ready for a rank promotion and sets the promotion arc flag.
         */
        const checkPromotion = () => {
            let nextRankThreshold;
            const rankOrder = customizableTerms.ranks;
            const currentRankIndex = rankOrder.indexOf(playerRank);
            if (currentRankIndex < rankOrder.length - 1) {
                const nextRank = rankOrder[currentRankIndex + 1];
                nextRankThreshold = RANK_THRESHOLDS[nextRank];
            } else {
                nextRankThreshold = Infinity;
            }

            if (!isPromotionArc && lifetimeEnergy >= nextRankThreshold) {
                isPromotionArc = true;
                saveState();
            }
        };
        
        /**
         * Generates two origin stories for the new player using the Gemini API.
         * @param {string} charName - The character's name.
         */
        const generateOriginStory = async (charName) => {
            const universe = customizableTerms.universe;
            const homes = customizableTerms.homeNames.join(', ');
            const groupTitle = customizableTerms.groupTitle;
            const specialityTitle = customizableTerms.specialityTitle;
            
            // Updated prompt to use the new specialityTitle
            const prompt = `The universe is "${universe}". You are a master storyteller with a full understanding of the storytelling nuances that match with the "${universe}" content. You have a full understanding of the laws and story of the "${universe}" universe. The current character's name is ${charName}. The tone, style, and lore of the story must be authentic to this universe. The character's personality is "${characterDescription}". Generate two distinct, short background stories for them to choose from. Each story should be a single short paragraph describing their past and how they arrived at their current position and rank. Use lore, terminology, and key concepts from the "${universe}" universe to make the story feel authentic. The response MUST be a single JSON object with a key "origins", which contains an array of two story objects. Each object must have keys "story" (the paragraph), "home" (the name of their origin from (${homes})), "group" ( a "${groupTitle}" from in universe that the player belongs to), "personality" (1-2 words describing their personality), and "speciality" (1-2 words describing their special power or skill, based on any staple powers or skills in universe). The values for "home" and "group" should be from the provided list, and the other values should be created based on the story.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "origins": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "story": {"type": "STRING"},
                                        "home": {"type": "STRING", "enum": customizableTerms.homeNames},
                                        "group": {"type": "STRING"},
                                        "personality": {"type": "STRING"},
                                        "speciality": {"type": "STRING"}
                                    }
                                },
                                "minItems": 2,
                                "maxItems": 2
                            }
                        }
                    }
                }
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            if (originChoicesContainer) originChoicesContainer.innerHTML = `<div class="col-span-2 text-center text-gray-400"><div class="loading-spinner mx-auto mb-2"></div>Unrolling your scroll of destiny...</div>`;
            if (originStoryContainer) originStoryContainer.classList.remove('hidden');

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    if (originChoicesContainer) originChoicesContainer.innerHTML = '';
                    data.origins.forEach((origin, index) => {
                        const choiceCard = document.createElement('div');
                        choiceCard.className = 'p-4 rounded-lg shadow-md bg-gray-900 flex flex-col items-center text-white';
                        choiceCard.innerHTML = `
                            <p class="mb-4 whitespace-pre-wrap">${origin.story}</p>
                            <ul class="text-sm text-gray-400 space-y-1 mb-4 w-full text-left">
                                <li> Origin: ${origin.home}</li>
                                <li> ${groupTitle}: ${origin.group}</li>
                                <li> Personality: ${origin.personality}</li>
                                <li> ${specialityTitle}: ${origin.speciality}</li>
                            </ul>
                            <button class="select-origin-button bg-[#00FFD1] text-black font-bold py-2 px-4 rounded-full transition-all active:scale-95" data-story-index="${index}">Choose This Path</button>
                        `;
                        if (originChoicesContainer) originChoicesContainer.appendChild(choiceCard);
                    });
                     if (originStoryContainer) originStoryContainer.dataset.origins = JSON.stringify(data.origins);
                } else {
                    throw new Error("Invalid response from API");
                }
            } catch (error) {
                console.error("Error generating origin story:", error);
                if (originChoicesContainer) originChoicesContainer.innerHTML = `<p class="text-red-500 text-center">Failed to generate origin stories. Please try again.</p>`;
                if (generateStoryButton) generateStoryButton.disabled = false;
            } finally {
                if (storyLoadingIndicator) storyLoadingIndicator.classList.add('hidden');
            }
        };
        if (rerollOriginButton) rerollOriginButton.addEventListener('click', () => {
            const nameFromStorage = localStorage.getItem('characterName');
            if (nameFromStorage) {
                generateOriginStory(nameFromStorage);
            }
        });

        /**
         * Records the chosen origin story and initializes the character bio.
         * @param {object} origin - The selected origin story object.
         */
        const recordOriginStory = (origin) => {
            const newStory = origin.story + '\n\n' + Object.entries(origin).filter(([key]) => key !== 'story').map(([key, value]) => ` ${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`).join('\n');
            
            const newCharacterBio = {
                home: origin.home,
                group: origin.group,
                personality: origin.personality,
                speciality: origin.speciality
            };

            playerChronicle.push({ date: new Date().toLocaleDateString(), story: newStory, points: 0, title: 'Origin' });
            characterBio = newCharacterBio;
            characterName = localStorage.getItem('characterName');
            saveState();

            if (originStoryContainer) originStoryContainer.classList.add('hidden');
            if (generateStoryButton) generateStoryButton.disabled = false;
            updateStoryStatus();
            
            // Re-render the main UI after selecting origin story
            updatePointsDisplay();
            renderEnergySummary();
            renderTasks('daily');
            renderTasks('weekly');
            renderTasks('monthly');
            renderRewards();
            updateRankAndSkillDisplay();
            updateImageGeneratorStatus();
        };

        /**
         * Generates the next segment of the player's story using the Gemini API.
         * @param {string} currentCharacterName - The character's name.
         */
        const generateStory = async (currentCharacterName) => {
            if (playerChronicle.length === 0) {
                 if (characterName) {
                     if(originNameDisplay) originNameDisplay.textContent = characterName;
                     await generateOriginStory(characterName);
                 } else {
                     if(namingModal) namingModal.style.display = 'flex';
                 }
                 return;
            }

            let rankPrompt = '';
            let arcType = 'regular';
            let skillGain = '';
            
            const canonChronicles = retiredChronicles.map(c => c.story).join(' ');
            const fullChronicle = playerChronicle.map(s => s.story).join(' ');
            
            // Get pronouns
            const pronouns = playerPronouns.split('/');
            const [subjective, objective, possessive] = pronouns;

            let pronounPrompt = '';
            if (subjective === 'they') {
                 pronounPrompt = `The character's pronouns are they/them. Use 'they', 'them', and 'their' throughout the story.`;
            } else {
                 pronounPrompt = `The character's pronouns are ${subjective}/${objective}. Use '${subjective}', '${objective}', and '${possessive}' throughout the story.`;
            }

            switch (playerRank) {
                case customizableTerms.ranks[0]:
                    rankPrompt = `You are a new ${customizableTerms.ranks[0]}. The story should take place in your home of ${characterBio.home} where you are learning basic techniques in a large class with a ${customizableTerms.ranks[2]} instructor. Interactions should involve classroom dynamics, basic drills, and possibly guests from other classes. You are known for your ${characterBio.personality} personality and your ${customizableTerms.specialityTitle} in ${characterBio.speciality}. Your ${customizableTerms.groupTitle} is the ${characterBio.group}.`;
                    break;
                case customizableTerms.ranks[1]:
                    rankPrompt = `You are now a ${customizableTerms.ranks[1]}. The story should focus on their three-person squad, led by a ${customizableTerms.ranks[3]} sensei. They are tasked with C-rank or early B-rank tasks, learning teamwork, and applying their skills in the field. Your ${customizableTerms.specialityTitle} is ${characterBio.speciality}.`;
                    break;
                case customizableTerms.ranks[2]:
                    rankPrompt = `You are a ${customizableTerms.ranks[2]}. The story should be about you leading a team of ${customizableTerms.ranks[1]} on a task or handling administrative tasks within the home, reflecting your increased responsibility. Your ${customizableTerms.specialityTitle} is ${characterBio.speciality}.`;
                    break;
                case customizableTerms.ranks[3]:
                    rankPrompt = `You are an elite ${customizableTerms.ranks[3]}. The story should involve high-stakes tasks (A- or S-rank), solo assignments, or their role as a mentor to ${customizableTerms.ranks[1]}, reflecting their position of power and experience. Your ${customizableTerms.specialityTitle} is ${characterBio.speciality}.`;
                    break;
            }
            
            if (isPromotionArc) {
                arcType = 'promotion';
                rankPrompt = `The next part of their story should be a promotion exam. Describe the challenges they face in this critical test of skill.`;
            }

            const arcPrompt = (currentChapterInArc === ARC_LENGTH) ? `It is the end of an arc. This segment should conclude the current plotline.` : '';
            
            if (missionsCompletedSinceLastStory >= MIN_MISSIONS_FOR_STORY) {
                if (Math.random() < 0.25) {
                    skillGain = `The user has performed exceptionally well. Include a small positive event where they discover or a new ${customizableTerms.skillSectionTitle}. Name the new ${customizableTerms.skillSectionTitle} at the end of the narrative in the format [NEW SKILL: Skill Name].`;
                }
            }
            const prompt = `You are a master storyteller in the style of a ${customizableTerms.universe} universe. The character is a young ${customizableTerms.playerTitle} named ${currentCharacterName}. ${pronounPrompt} Their lifetime Energy is ${lifetimeEnergy}. Their current rank is ${playerRank}. Their chronicle is: ${fullChronicle}. Additionally, there are past legendary players who exist in this world: ${canonChronicles}. This is Arc ${currentArc}. This is Chapter ${currentChapterInArc} of the arc, which has a length of ${ARC_LENGTH} chapters. ${rankPrompt} ${arcPrompt} ${skillGain} Tell a short narrative segment that ends at a crucial moment, requiring a choice. The narrative should be no more than 3 paragraphs and follow good pacing for a ${customizableTerms.universe} universe. For a ${customizableTerms.universe} story, the conflict should not involve physical fighting unless the universe is an action universe. It must end with a single question like, "What does ${currentCharacterName} do?" and should not use any other anime or universes. The AI should not use the chapter count to dictate the narrative pacing or to plan climaxes, but should instead focus on a single, compelling narrative entry.`;
            
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            if (storyLoadingIndicator) storyLoadingIndicator.classList.remove('hidden');
            if (generateStoryButton) generateStoryButton.disabled = true;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (storyOutput) storyOutput.innerHTML = `<p class="whitespace-pre-wrap">${text}</p>`;
                    temporaryStorySegment = text;
                    lastStoryTime = new Date().getTime();
                    missionsCompletedSinceLastStory = 0;
                    saveState();
                    generateChoices(text, arcType);
                } else {
                    throw new Error("Invalid response from API");
                }
            } catch (error) {
                console.error("Error fetching from API:", error);
                if (storyOutput) storyOutput.innerHTML = '<p class="text-red-500">Failed to generate story. Please check your network and try again.</p>';
                if (storyLoadingIndicator) storyLoadingIndicator.classList.add('hidden');
                if (generateStoryButton) generateStoryButton.disabled = false;
            }
        };

        /**
         * Generates four choices for the user based on the generated story segment.
         * @param {string} storyText - The story segment to base choices on.
         * @param {string} arcType - The type of arc ('regular' or 'promotion').
         */
        const generateChoices = async (storyText, arcType) => {
            // Updated prompt to generate more varied choices and include a skill.
            const prompt = `Based on the following short story about a character, generate exactly 4 possible and drastically different next actions for the character. The choices should be short, one-sentence descriptions. At least one choice should involve using a known skill if any exist. The known skills are: ${knownSkills.join(', ')}. If no skills are known, provide four general choices. Do not ask a question. Respond with a single JSON object with a key named "choices" which is an array of strings. Do not include any other text or formatting outside the JSON object. The story is:\n\n"${storyText}"`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "choices": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" },
                                "maxItems": 4,
                                "minItems": 4
                            }
                        }
                    }
                }
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            if(choiceButtonsContainer) choiceButtonsContainer.innerHTML = `<div class="col-span-2 text-center text-gray-400"><div class="loading-spinner mx-auto mb-2"></div>Generating choices...</div>`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    if (choiceButtonsContainer) choiceButtonsContainer.innerHTML = '';
                    data.choices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-button bg-gray-800 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-700 transition-all text-sm active:scale-95';
                        button.textContent = choice;
                        button.addEventListener('click', () => {
                            generateChoiceOutcome(characterName, choice, missionsCompletedSinceLastStory, arcType);
                        });
                        if (choiceButtonsContainer) choiceButtonsContainer.appendChild(button);
                    });
                    if (choiceSystemContainer) choiceSystemContainer.classList.remove('hidden');
                } else {
                    throw new Error("Invalid response from API");
                }
            } catch (error) {
                console.error("Error generating choices:", error);
                if (choiceButtonsContainer) choiceButtonsContainer.innerHTML = `<p class="text-red-500 text-center">Failed to generate choices. Please try again.</p>`;
                if (generateStoryButton) generateStoryButton.disabled = false;
            }
        };

        /**
         * Generates the outcome of the user's chosen action.
         * @param {string} characterName - The character's name.
         * @param {string} userChoice - The choice made by the user.
         * @param {number} missionsCompleted - Number of missions completed since the last story.
         * @param {string} arcType - The type of arc ('regular' or 'promotion').
         */
        const generateChoiceOutcome = async (characterName, userChoice, missionsCompleted, arcType) => {
            const successRate = missionsCompleted >= MIN_MISSIONS_FOR_STORY ? "high" : "low";
            let prompt;
            
            // Get pronouns
            const pronouns = playerPronouns.split('/');
            const [subjective, objective, possessive] = pronouns;
            
            // Adjust prompt for sitcom
            if (customizableTerms.universe === 'Sitcom') {
                prompt = `You are a storyteller for a sitcom. The ${customizableTerms.playerTitle} named ${characterName} is in the middle of a story. The previous action was "${temporaryStorySegment}". Their choice is "${userChoice}". Based on their recent tasks success (which gives them a ${successRate} chance of success), write a short story segment that continues the narrative and resolves the choice they made. The conflict and resolution should be humorous and based on character drama, not physical fighting. The pronouns for the character are ${subjective}/${objective}.`;
            } else {
                prompt = `You are a storyteller. The ${customizableTerms.playerTitle} named ${characterName} is in the middle of a story. The previous action was "${temporaryStorySegment}". Their choice is "${userChoice}". Based on their recent tasks success (which gives them a ${successRate} chance of success), write a short story segment that continues the narrative and resolves the choice they made. The universe of this story is ${customizableTerms.universe}. The pronouns for the character are ${subjective}/${objective}.`;
            }

            if (arcType === 'promotion') {
                prompt = `The ${customizableTerms.playerTitle} named ${characterName} is in the middle of their exam. Their previous action was described as "${temporaryStorySegment}". Their choice is "${userChoice}". Because they have a ${successRate} chance of success, describe the outcome of the exam. If they are successful, mention them achieving their new rank. The universe of this story is ${customizableTerms.universe}. The pronouns for the character are ${subjective}/${objective}.`;
            }

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // Hide the choices and show the loading spinner
            if(choiceButtonsContainer) choiceButtonsContainer.innerHTML = '';
            if(choiceLoadingIndicator) choiceLoadingIndicator.classList.remove('hidden');
            if(choiceOutcomeOutput) choiceOutcomeOutput.classList.add('hidden');
            temporaryChoice = userChoice;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                    const outcomeText = result.candidates[0].content.parts[0].text;
                    
                    const skillMatch = outcomeText.match(/\[NEW SKILL: (.+?)\]/);
                    if (skillMatch) {
                        const newSkill = skillMatch[1];
                        if (!knownSkills.includes(newSkill)) {
                            knownSkills.push(newSkill);
                            saveState();
                        }
                    }

                    if (arcType === 'promotion') {
                        const newRankMap = {
                            [customizableTerms.ranks[0]]: customizableTerms.ranks[1],
                            [customizableTerms.ranks[1]]: customizableTerms.ranks[2],
                            [customizableTerms.ranks[2]]: customizableTerms.ranks[3]
                        };
                        const success = outcomeText.toLowerCase().includes('successfully') || outcomeText.toLowerCase().includes('succeeded') || outcomeText.toLowerCase().includes('passed');
                        
                        if (success) {
                            playerRank = newRankMap[playerRank];
                            showMessageModal(`Congratulations! You have been promoted to ${playerRank}!`);
                        } else {
                            showMessageModal("You did not succeed in your promotion exam. Train harder and try again!");
                        }
                        isPromotionArc = false;
                        saveState();
                    }

                    if(choiceOutcomeOutput) {
                        choiceOutcomeOutput.innerHTML = `<p class="whitespace-pre-wrap">${outcomeText}</p>`;
                        choiceOutcomeOutput.classList.remove('hidden');
                    }
                    temporaryOutcome = outcomeText;
                    if(recordButtonContainer) recordButtonContainer.classList.remove('hidden');

                } else {
                    throw new Error("Invalid response from API");
                }
            } catch (error) {
                console.error("Error generating choice outcome:", error);
                if(choiceOutcomeOutput) {
                    choiceOutcomeOutput.innerHTML = `<p class="text-red-500">Failed to unfold the outcome. Please try again.</p>`;
                    choiceOutcomeOutput.classList.remove('hidden');
                }
                if(recordButtonContainer) recordButtonContainer.classList.add('hidden');
                if(generateStoryButton) generateStoryButton.disabled = false;
            } finally {
                if(choiceLoadingIndicator) choiceLoadingIndicator.classList.add('hidden');
            }
        };
        
        if (recordButton) recordButton.addEventListener('click', () => {
            if (temporaryStorySegment && temporaryChoice && temporaryOutcome) {
                const combinedStory = `${temporaryStorySegment}\n\n**Action:** "${temporaryChoice}"\n\n**Outcome:** ${temporaryOutcome}`;
                const newStory = {
                    date: new Date().toLocaleDateString(),
                    story: combinedStory,
                    points: lifetimeEnergy,
                    arc: currentArc,
                    chapter: currentChapterInArc
                };
                playerChronicle.push(newStory);
                
                currentChapterInArc++;
                if (currentChapterInArc > ARC_LENGTH) {
                    currentChapterInArc = 1;
                    currentArc++;
                }

                saveState();
                
                if (storyOutput) storyOutput.classList.add('hidden');
                if (choiceSystemContainer) choiceSystemContainer.classList.add('hidden');
                if (originStoryContainer) originStoryContainer.classList.add('hidden');
                if (recordButtonContainer) recordButtonContainer.classList.add('hidden');
                if (storyLoadingIndicator) storyLoadingIndicator.classList.add('hidden');

                temporaryStorySegment = '';
                temporaryChoice = '';
                temporaryOutcome = '';
                
                updateStoryStatus();
            } else {
                showMessageModal("No new story to record.");
            }
        });

        if (playerImageInput) playerImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (playerImageDisplay) playerImageDisplay.src = e.target.result;
                    playerImage = e.target.result;
                    saveState();
                };
                reader.readAsDataURL(file);
            }
        });
        
        if (modalBackgroundUploadInput) modalBackgroundUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.body.style.setProperty('--bg-image', `url('${e.target.result}')`);
                    customizableTerms.backgroundUrl = e.target.result;
                    saveState();
                    showMessageModal("New background image uploaded!");
                };
                reader.readAsDataURL(file);
            }
        });

        if (submitNameButton) submitNameButton.addEventListener('click', async () => {
            const name = startupNameInput.value.trim();
            if (name) {
                characterName = name;
                playerPronouns = document.getElementById('pronounSelect').value;
                characterDescription = document.getElementById('modalCharacterDescriptionTextarea').value.trim();
                saveState();
                if (namingModal) namingModal.style.display = 'none';
                if(originNameDisplay) originNameDisplay.textContent = name;
                
                // NEW BEHAVIOR: Do not automatically show description modal
                showMessageModal("Name saved! You can now explore the app and edit your character's description later.");
            } else {
                showMessageModal("Please enter a name to continue.");
            }
        });
        
        if (generateStoryButton) generateStoryButton.addEventListener('click', async () => {
            if (playerChronicle.length === 0) {
                 if (characterName) {
                     if(originNameDisplay) originNameDisplay.textContent = characterName;
                     await generateOriginStory(characterName);
                 } else {
                     if(namingModal) namingModal.style.display = 'flex';
                 }
                 return;
            }
            
            if (storyLoadingIndicator) storyLoadingIndicator.classList.remove('hidden');
            if (generateStoryButton) generateStoryButton.disabled = true;
            if (storyOutput) storyOutput.classList.remove('hidden');
            if (choiceSystemContainer) choiceSystemContainer.classList.add('hidden'); 
            checkPromotion();

            await generateStory(characterName);
        });

        if (generateImageButton) generateImageButton.addEventListener('click', async () => {
            if (playerChronicle.length === 0 || !characterDescription) {
                showMessageModal(`You need a character description and at least one story entry to generate an image. You can enter your description by clicking the pencil icon on your ${customizableTerms.playerTitle} image.`);
                return;
            }
            
            const [subjective, objective, possessive] = playerPronouns.split('/');
            let clothingPrompt = '';
            const isApprenticeOrHigher = customizableTerms.ranks.indexOf(playerRank) >= 1;
            const isJourneymanOrHigher = customizableTerms.ranks.indexOf(playerRank) >= 2;

            if (isApprenticeOrHigher) {
                clothingPrompt += `${subjective} is wearing a headband from the ${characterBio.home} village.`;
            }
            if (isJourneymanOrHigher) {
                clothingPrompt += `${subjective} is also wearing a standard home flak jacket.`;
            }
            
            const lastStory = playerChronicle[playerChronicle.length - 1];
            
            // Updated Prompt to be more dynamic and descriptive
            const prompt = `Create a high-quality, non-comic image in the artistic style of the "${customizableTerms.universe}" universe. The central subject is a player character with the description: "${characterDescription}". The character should be in a pose that references the events of their recent adventure, which is summarized as: "${lastStory.story}". The background of the image should also be a visual representation of a key moment or setting from that same story. Focus on rendering a unique character based on the description, not a pre-existing one. Do not include any text or dialogue.`;

            if (imageLoadingIndicator) imageLoadingIndicator.classList.remove('hidden');
            if (generateImageButton) generateImageButton.disabled = true;

            const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1} };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    generatedImageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    const playerImageDisplay = document.getElementById('playerImageDisplay');
                    if (playerImageDisplay) playerImageDisplay.src = generatedImageUrl;
                    
                    lastImageTime = new Date().getTime();
                    saveState();
                    
                    if (setProfileImageButton) setProfileImageButton.classList.remove('hidden');

                    showMessageModal("Your player image has been generated!");
                } else {
                    throw new Error("No valid image data in API response");
                }

            } catch (error) {
                console.error("Error generating image:", error);
                showMessageModal("Failed to generate image. Please try again later.");
            } finally {
                if (imageLoadingIndicator) imageLoadingIndicator.classList.add('hidden');
            }
        });
        if(setProfileImageButton) setProfileImageButton.addEventListener('click', () => {
            playerImage = generatedImageUrl;
            saveState();
            showMessageModal("New image set as your profile picture!");
            setProfileImageButton.classList.add('hidden');
        });
        
        /**
         * Renders the full chronicle of the player's story.
         */
        const renderChronicle = () => {
            if (!chronicleContent) return;
            chronicleContent.innerHTML = ''; // Clear previous content

            if (playerChronicle.length === 0) {
                chronicleContent.innerHTML = '<p class="text-center text-gray-400">Your player chronicle is empty. Complete tasks and reveal your story to begin your saga!</p>';
                return;
            }

            playerChronicle.forEach( (segment, index) => {
                const chapter = document.createElement('div');
                chapter.className = 'mb-6 pb-6 border-b-2 border-gray-700 last:border-b-0 last:pb-0';
                const chapterTitle = segment.title || `Arc ${segment.arc}, Chapter ${segment.chapter}`;
                
                const playButton = document.createElement('button');
                playButton.textContent = ' Play';
                playButton.className = 'bg-gray-700 text-white px-2 py-1 rounded-md ml-2 text-sm hover:bg-gray-600';
                playButton.onclick = () => playText(segment.story);

                chapter.innerHTML = `
                    <h3 class="font-bold text-xl mb-2 theme-heading">${chapterTitle} - ${segment.date}</h3>
                    <p class="whitespace-pre-wrap">${segment.story}</p>
                `;
                chapter.querySelector('h3').appendChild(playButton);
                chronicleContent.appendChild(chapter);
            });
        };
        
        if (viewChronicleButton) viewChronicleButton.addEventListener('click', () => {
            // Hide main content sections before showing the modal
            if (storyOutput) storyOutput.classList.add('hidden');
            if (choiceSystemContainer) choiceSystemContainer.classList.add('hidden');
            if (originStoryContainer) originStoryContainer.classList.add('hidden');
            
            // Render the chronicle and show the modal
            renderChronicle();
            if (chronicleModal) chronicleModal.style.display = 'flex';
        });

        if (closeChronicleModalButton) closeChronicleModalButton.addEventListener('click', () => {
            if (chronicleModal) chronicleModal.style.display = 'none';
        });

        /**
         * Converts text to speech and plays the audio using the TTS API.
         * @param {string} text - The text to be converted to speech.
         */
        const playText = async (text) => {
             const audioContext = new (window.AudioContext || window.webkitAudioContext)();
             const payload = {
                 contents: [{ parts: [{ text: text }] }],
                 generationConfig: {
                     responseModalities: ["AUDIO"],
                     speechConfig: {
                         voiceConfig: {
                             prebuiltVoiceConfig: { voiceName: "Kore" }
                         }
                     }
                 },
                 model: "gemini-2.5-flash-preview-tts"
             };
             const apiKey = "";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             
             try {
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });
                 const result = await response.json();
                 const part = result?.candidates?.[0]?.content?.parts?.[0];
                 const audioData = part?.inlineData?.data;
                 const mimeType = part?.inlineData?.mimeType;
                 
                 if (audioData && mimeType && mimeType.startsWith("audio/")) {
                     const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                     const pcmData = base64ToArrayBuffer(audioData);
                     const pcm16 = new Int16Array(pcmData);
                     const wavBlob = pcmToWav(pcm16, sampleRate);
                     const audioUrl = URL.createObjectURL(wavBlob);
                     
                     const audio = new Audio(audioUrl);
                     audio.play();
                 } else {
                     console.error("No valid audio data in API response");
                 }
             } catch (e) {
                 console.error("Error with TTS API:", e);
             }
        };

        /**
         * Converts raw PCM audio data to a WAV file Blob.
         * @param {Int16Array} pcm16 - The PCM audio data.
         * @param {number} sampleRate - The sample rate of the audio.
         * @returns {Blob} The audio as a WAV file Blob.
         */
        const pcmToWav = (pcm16, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);

            // RIFF identifier 'RIFF'
            writeString(view, 0, 'RIFF');
            // file size (byte length)
            view.setUint32(4, 36 + pcm16.length * 2, true);
            // RIFF type 'WAVE'
            writeString(view, 8, 'WAVE');
            // format chunk identifier 'fmt '
            view.setUint32(16, 16, true);
            // sample format (raw)
            view.setUint16(20, 1, true);
            // channel count
            view.setUint16(22, 1, true);
            // sample rate
            view.setUint32(24, sampleRate, true);
            // byte rate (sample rate * block align)
            view.setUint32(28, sampleRate * 2, true);
            // block align (channel count * bytes per sample)
            view.setUint16(32, 2, true);
            // bits per sample
            view.setUint16(34, 16, true);
            // data chunk identifier 'data'
            writeString(view, 36, 'data');
            // data chunk length
            view.setUint32(40, pcm16.length * 2, true);
            
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        };

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };
        
        const base64ToArrayBuffer = (base64) => {
             const binaryString = atob(base64);
             const len = binaryString.length;
             const bytes = new Uint8Array(len);
             for (let i = 0; i < len; i++) {
                 bytes[i] = binaryString.charCodeAt(i);
             }
             return bytes.buffer;
        };


        if(playerImageDisplay) playerImageDisplay.addEventListener('click', () => {
            if(playerImage && playerImage !== 'https://placehold.co/150x150/073B4C/FFF?text=Your+Player') {
                enlargedImage.src = playerImage;
                imageModal.style.display = 'flex';
            }
        });

        if(imageModal) imageModal.addEventListener('click', (e) => {
            if(e.target === imageModal || e.target === enlargedImage) {
                imageModal.style.display = 'none';
            }
        });
        
        /**
         * Initializes the main application by loading saved state and rendering the UI.
         */
        const initializeMainApp = () => {
            // Check for a thematic font and apply it
            const fontDetails = fontMap[customizableTerms.universe];
            if (fontDetails) {
                const fontLink = document.getElementById('themeFont');
                if (fontLink) {
                    fontLink.href = fontDetails.url;
                }
                document.documentElement.style.setProperty('--theme-font', `'${fontDetails.name}', monospace`);
            } else {
                 document.documentElement.style.setProperty('--theme-font', `'Roboto Mono', monospace`);
            }
            
            document.getElementById('docTitle').textContent = customizableTerms.appTitle;
            document.getElementById('appTitleDisplay').textContent = customizableTerms.appTitle;
            document.getElementById('playerTitleDisplay').textContent = customizableTerms.playerTitle;
            document.getElementById('playerTitleDisplay2').textContent = customizableTerms.playerTitle;
            document.getElementById('playerTitleDisplay3').textContent = customizableTerms.playerTitle;
            document.getElementById('skillSectionHeading').textContent = `${customizableTerms.skillSectionTitle} Scrolls`;
            document.getElementById('createSkillHeading').textContent = `Create New ${customizableTerms.skillSectionTitle}`;
            document.getElementById('availableScrollsHeading').textContent = `Available Scrolls`;
            if (document.getElementById('missionModalTitle')) document.getElementById('missionModalTitle').textContent = `Manage ${customizableTerms.taskTitle}s`;
            if (document.getElementById('dailyTasksPanel')) document.getElementById('dailyTasksPanel').querySelector('h2').textContent = `Daily ${customizableTerms.taskTitle}s`;
            if (document.getElementById('weeklyTasksPanel')) document.getElementById('weeklyTasksPanel').querySelector('h2').textContent = `Weekly ${customizableTerms.taskTitle}s`;
            if (document.getElementById('monthlyTasksPanel')) document.getElementById('monthlyTasksPanel').querySelector('h2').textContent = `Monthly ${customizableTerms.taskTitle}s`;


            if (customizableTerms.backgroundUrl) {
                document.body.style.setProperty('--bg-image', `url('${customizableTerms.backgroundUrl}')`);
            } else {
                document.body.style.setProperty('--bg-image', `none`);
            }
            document.documentElement.style.setProperty('--theme-color', customizableTerms.themeColor);

            renderNewSkillCostInputs();
            checkDailyReset();
            
            // Check if a character name is set. If not, open the naming modal.
            if (!characterName) {
                const namingModal = document.getElementById('namingModal');
                if (namingModal) namingModal.style.display = 'flex';
            } else {
                // If a character name exists, load the full app state.
                if(characterNameDisplay) characterNameDisplay.textContent = characterName;
                if(playerImageDisplay) playerImageDisplay.src = playerImage;
                if (allTasks.length === 0) {
                    allTasks = [...defaultTasks];
                }
                updatePointsDisplay();
                renderEnergySummary();
                renderTasks('daily');
                renderTasks('weekly');
                renderTasks('monthly');
                renderRewards();
                updateStoryStatus();
                updateRankAndSkillDisplay();
                updateImageGeneratorStatus();
            }
        };
        
        const tutorialSteps = [
            {
                title: "The Player Panel",
                text: `This area shows your alter-ego's name, rank, and the current story unfolding based on your progress. It's your window into the other dimension.`,
                highlightElement: '#playerPanel'
            },
            {
                title: "The Tasks Panel",
                text: `The central part of the console displays your daily, weekly, and monthly tasks. Completing these earns you "Energy," which can be used to unlock skills and is reflected in your alter-ego's abilities.`,
                highlightElement: '#dailyTasksPanel'
            },
            {
                title: "The Skills Panel",
                text: `This section is your reward center. Use the Energy you've earned from completing tasks to acquire new skills for yourself and your alter-ego, motivating you to keep making progress.`,
                highlightElement: '#skillsPanel'
            },
            {
                title: "Customize Your Experience",
                text: `Before we begin, you need to configure your universe. You can change the theme, titles, and other terms to create a world that inspires you.`,
                highlightElement: '#openCustomizationFromMain'
            }
        ];
        
        let currentTutorialStep = 0;
        
        /**
         * Removes the highlighting from the currently highlighted tutorial element.
         */
        const removeHighlight = () => {
            const highlighted = document.querySelector('.highlight-tutorial');
            if (highlighted) {
                highlighted.classList.remove('highlight-tutorial');
            }
        };
        
        /**
         * Updates the tutorial modal content and highlights the relevant UI element.
         */
        const updateTutorialStep = () => {
            const tutorialTitle = document.getElementById('tutorialTitle');
            const tutorialText = document.getElementById('tutorialText');
            const nextTutorialButton = document.getElementById('nextTutorial');
            const prevTutorialButton = document.getElementById('prevTutorial');
            
            if (tutorialTitle) tutorialTitle.textContent = tutorialSteps[currentTutorialStep].title;
            if (tutorialText) tutorialText.textContent = tutorialSteps[currentTutorialStep].text;

            removeHighlight();
            const currentStep = tutorialSteps[currentTutorialStep];
            const elementToHighlight = document.querySelector(currentStep.highlightElement);
            if (elementToHighlight) {
                elementToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                elementToHighlight.classList.add('highlight-tutorial');
            }

            if(prevTutorialButton) prevTutorialButton.style.display = currentTutorialStep === 0 ? 'none' : 'block';
            if(nextTutorialButton) nextTutorialButton.textContent = currentTutorialStep === tutorialSteps.length - 1 ? 'Start Customizing' : 'Next';
        };

        /**
         * Initiates the tutorial sequence.
         */
        const showTutorial = () => {
            const tutorialModal = document.getElementById('tutorialModal');
            if (tutorialModal) {
                currentTutorialStep = 0;
                tutorialModal.style.display = 'flex';
                updateTutorialStep();
            }
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            const customizationModal = document.getElementById('customizationModal');
            const masterResetButton = document.getElementById('masterResetButton');
            const openCustomizationButton = document.getElementById('openCustomizationFromMain');
            const closeCustomizationModalButton = document.getElementById('closeCustomizationModal');
            const saveCustomizationButton = document.getElementById('saveCustomizationButton');
            const cancelCustomizationButton = document.getElementById('cancelCustomizationButton');
            const generateThemeButton = document.getElementById('generateThemeButton');
            const universeInput = document.getElementById('universeInput');
            const themeLoadingIndicator = document.getElementById('themeLoadingIndicator');
            const customizationContent = document.getElementById('customizationContent');
            const themeGeneratorContent = document.getElementById('themeGeneratorContent');
            const rerollThemeButton = document.getElementById('rerollThemeButton');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const initiateButton = document.getElementById('initiateButton');
            const tutorialModal = document.getElementById('tutorialModal');
            const themeGeneratorTab = document.getElementById('themeGeneratorTab');
            const manualCustomizationTab = document.getElementById('manualCustomizationTab');
            
            const customAppTitleInput = document.getElementById('customAppTitle');
            const customPlayerTitleInput = document.getElementById('customPlayerTitle');
            const customMasterTitleInput = document.getElementById('customMasterTitle');
            const customSkillSectionTitleInput = document.getElementById('customSkillSectionTitle');
            const customTaskTitleInput = document.getElementById('customTaskTitle');
            const customRanksInput = document.getElementById('customRanks');
            const customEnergyTypesInput = document.getElementById('customEnergyTypes');
            const customHomeNamesInput = document.getElementById('customHomeNames');
            const customGroupTitleInput = document.getElementById('customGroupTitle');
            const customSpecialityTitleInput = document.getElementById('customSpecialityTitle');
            const customBackgroundUrlInput = document.getElementById('customBackgroundUrl');
            const customThemeColorInput = document.getElementById('customThemeColor');
            
            const modalBackgroundUploadInput = document.getElementById('modalBackgroundUploadInput');
            const modalCharacterDescriptionTextarea = document.getElementById('modalCharacterDescriptionTextarea');

            if(customGroupTitleInput) customGroupTitleInput.value = customizableTerms.groupTitle;
            if(customSpecialityTitleInput) customSpecialityTitleInput.value = customizableTerms.specialityTitle;

            if (initiateButton) {
                initiateButton.addEventListener('click', () => {
                    welcomeScreen.style.opacity = '0';
                    setTimeout(() => {
                        // Use remove() to completely eliminate the element from the DOM
                        welcomeScreen.remove();
                        showTutorial();
                    }, 1000);
                });
            }

            document.body.addEventListener('click', (e) => {
                if (e.target.id === 'nextTutorial') {
                    if (currentTutorialStep < tutorialSteps.length - 1) {
                        currentTutorialStep++;
                        updateTutorialStep();
                    } else {
                        if (tutorialModal) tutorialModal.style.display = 'none';
                        // NEW BEHAVIOR: On first run, open customization modal after tutorial.
                        if (customizationModal) customizationModal.style.display = 'flex';
                        if (themeGeneratorContent) themeGeneratorContent.classList.remove('hidden');
                        if (customizationContent) customizationContent.classList.add('hidden');
                        if (themeGeneratorTab) {
                            themeGeneratorTab.classList.add('border-[#00FFD1]', 'text-white');
                            if(manualCustomizationTab) manualCustomizationTab.classList.remove('border-[#00FFD1]', 'text-white');
                        }
                    }
                }
                if (e.target.id === 'prevTutorial') {
                    if (currentTutorialStep > 0) {
                        currentTutorialStep--;
                        updateTutorialStep();
                    }
                }
            });
            if (themeGeneratorTab) themeGeneratorTab.addEventListener('click', () => {
                if (customizationContent) customizationContent.classList.add('hidden');
                if (themeGeneratorContent) themeGeneratorContent.classList.remove('hidden');
                if (themeGeneratorTab) themeGeneratorTab.classList.add('border-[#00FFD1]', 'text-white');
                if (manualCustomizationTab) manualCustomizationTab.classList.remove('border-[#00FFD1]', 'text-white');
            });
            if (manualCustomizationTab) manualCustomizationTab.addEventListener('click', () => {
                if (themeGeneratorContent) themeGeneratorContent.classList.add('hidden');
                if (customizationContent) customizationContent.classList.remove('hidden');
                if (manualCustomizationTab) manualCustomizationTab.classList.add('border-[#00FFD1]', 'text-white');
                if (themeGeneratorTab) themeGeneratorTab.classList.remove('border-[#00FFD1]', 'text-white');
            });

            if (openCustomizationButton) {
                openCustomizationButton.addEventListener('click', () => {
                    customizationModal.style.display = 'flex';
                    // Open to the manual customization tab by default
                    if (customizationContent) customizationContent.classList.remove('hidden');
                    if (themeGeneratorContent) themeGeneratorContent.classList.add('hidden');
                    if (customAppTitleInput) customAppTitleInput.value = customizableTerms.appTitle;
                    if (customPlayerTitleInput) customPlayerTitleInput.value = customizableTerms.playerTitle;
                    if (customMasterTitleInput) customMasterTitleInput.value = customizableTerms.masterTitle;
                    if (customSkillSectionTitleInput) customSkillSectionTitleInput.value = customizableTerms.skillSectionTitle;
                    if (customTaskTitleInput) customTaskTitleInput.value = customizableTerms.taskTitle;
                    if (customRanksInput) customRanksInput.value = Array.isArray(customizableTerms.ranks) ? customizableTerms.ranks.join(', ') : '';
                    if (customEnergyTypesInput) customEnergyTypesInput.value = Array.isArray(customizableTerms.energyTypes) ? customizableTerms.energyTypes.join(', ') : '';
                    if (customHomeNamesInput) customHomeNamesInput.value = Array.isArray(customizableTerms.homeNames) ? customizableTerms.homeNames.join(', ') : '';
                    if (customGroupTitleInput) customGroupTitleInput.value = customizableTerms.groupTitle;
                    if (customSpecialityTitleInput) customSpecialityTitleInput.value = customizableTerms.specialityTitle;
                    if (customBackgroundUrlInput) customBackgroundUrlInput.value = customizableTerms.backgroundUrl;
                    if (customThemeColorInput) customThemeColorInput.value = customizableTerms.themeColor;
                });
            }

            masterResetButton.addEventListener('click', () => {
                showConfirmationModal(
                    'Master Reset',
                    'This will permanently delete all your progress, tasks, and customizations. The page will reload and you will start over as a new player. Do you want to proceed?',
                    null,
                    () => {
                        masterReset();
                    }
                );
            });
            
            if (closeCustomizationModalButton) closeCustomizationModalButton.addEventListener('click', () => {
                if (customizationModal) customizationModal.style.display = 'none';
            });

            if (cancelCustomizationButton) cancelCustomizationButton.addEventListener('click', () => {
                if (customizationModal) customizationModal.style.display = 'none';
            });
            
            if (saveCustomizationButton) saveCustomizationButton.addEventListener('click', async () => {
                const newCustomTerms = {
                    appTitle: customAppTitleInput.value.trim() || defaultCustomizableTerms.appTitle,
                    playerTitle: customPlayerTitleInput.value.trim() || defaultCustomizableTerms.playerTitle,
                    masterTitle: customMasterTitleInput.value.trim() || defaultCustomizableTerms.masterTitle,
                    skillSectionTitle: customSkillSectionTitleInput.value.trim() || defaultCustomizableTerms.skillSectionTitle,
                    createSkillHeading: `Create New ${customSkillSectionTitleInput.value.trim() || 'Skill'}`,
                    availableScrollsHeading: `Available ${customSkillSectionTitleInput.value.trim() || 'Scrolls'}`,
                    taskTitle: customTaskTitleInput.value.trim() || defaultCustomizableTerms.taskTitle,
                    ranks: (customRanksInput.value || '').split(',').map(rank => rank.trim()) || defaultCustomizableTerms.ranks,
                    energyTypes: (customEnergyTypesInput.value || '').split(',').map(type => type.trim()) || defaultCustomizableTerms.energyTypes,
                    homeNames: (customHomeNamesInput.value || '').split(',').map(name => name.trim()) || defaultCustomizableTerms.homeNames,
                    groupTitle: customGroupTitleInput.value.trim() || defaultCustomizableTerms.groupTitle,
                    specialityTitle: customSpecialityTitleInput.value.trim() || defaultCustomizableTerms.specialityTitle,
                    backgroundUrl: customBackgroundUrlInput.value.trim() || defaultCustomizableTerms.backgroundUrl,
                    themeColor: customThemeColorInput.value.trim() || defaultCustomizableTerms.themeColor,
                    universe: customizableTerms.universe // Keep the current universe, which is set by the AI generator.
                };
                
                showConfirmationModal(
                    'Apply Customization',
                    'This will reset your character, rank, and chronicle but keep your energy levels and tasks. Do you want to proceed?',
                    null,
                    () => {
                        localStorage.setItem('customizableTerms', JSON.stringify(newCustomTerms));
                        localStorage.setItem('themeChosen', 'true');
                        
                        // Soft reset logic
                        characterName = '';
                        playerPronouns = 'they/them';
                        playerChronicle = [];
                        playerImage = '';
                        characterDescription = '';
                        characterBio = null;
                        playerRank = newCustomTerms.ranks[0];
                        missionsCompletedSinceLastStory = 0;
                        lastStoryTime = 0;
                        lastImageTime = 0;
                        currentArc = 1;
                        currentChapterInArc = 1;
                        
                        // Apply the new theme to the current page without a reload
                        customizableTerms = newCustomTerms;
                        document.getElementById('appTitleDisplay').textContent = customizableTerms.appTitle;
                        document.getElementById('playerTitleDisplay').textContent = customizableTerms.playerTitle;
                        document.getElementById('playerTitleDisplay2').textContent = customizableTerms.playerTitle;
                        document.getElementById('playerTitleDisplay3').textContent = customizableTerms.playerTitle;
                        document.getElementById('skillSectionHeading').textContent = `${customizableTerms.skillSectionTitle} Scrolls`;
                        document.getElementById('createSkillHeading').textContent = `Create New ${customizableTerms.skillSectionTitle}`;
                        document.getElementById('availableScrollsHeading').textContent = `Available Scrolls`;
                        if (document.getElementById('missionModalTitle')) document.getElementById('missionModalTitle').textContent = `Manage ${customizableTerms.taskTitle}s`;
                        if (document.getElementById('dailyTasksPanel')) document.getElementById('dailyTasksPanel').querySelector('h2').textContent = `Daily ${customizableTerms.taskTitle}s`;
                        if (document.getElementById('weeklyTasksPanel')) document.getElementById('weeklyTasksPanel').querySelector('h2').textContent = `Weekly ${customizableTerms.taskTitle}s`;
                        if (document.getElementById('monthlyTasksPanel')) document.getElementById('monthlyTasksPanel').querySelector('h2').textContent = `Monthly ${customizableTerms.taskTitle}s`;


                        if (customizableTerms.backgroundUrl) {
                            document.body.style.setProperty('--bg-image', `url('${customizableTerms.backgroundUrl}')`);
                        } else {
                            document.body.style.setProperty('--bg-image', `none`);
                        }
                        document.documentElement.style.setProperty('--theme-color', customizableTerms.themeColor);

                        // Clear the UI elements
                        document.getElementById('characterNameDisplay').textContent = '';
                        document.getElementById('playerImageDisplay').src = 'https://placehold.co/150x150/073B4C/FFF?text=Your+Player';
                        document.getElementById('skillList').innerHTML = `<li class="text-gray-400">No ${customizableTerms.skillSectionTitle} learned yet.</li>`;
                        if (storyOutput) storyOutput.classList.add('hidden');
                        if (choiceSystemContainer) choiceSystemContainer.classList.add('hidden');
                        if (originStoryContainer) originStoryContainer.classList.add('hidden');

                        // Reset tasks and rewards UI
                        renderTasks('daily');
                        renderTasks('weekly');
                        renderTasks('monthly');
                        renderRewards();
                        
                        // After saving the theme and clearing the old character data,
                        // we call the initialization function which will properly
                        // show the naming modal since characterName is now empty.
                        saveState();
                        if (customizationModal) customizationModal.style.display = 'none';
                        initializeMainApp();
                        
                    }
                );
            });
            
            /**
             * Generates a new theme based on the user's input and populates the manual customization fields.
             * @param {string} universe - The user-provided theme or universe.
             */
            const generateAndPopulateTheme = async (universe) => {
                if (themeLoadingIndicator) themeLoadingIndicator.classList.remove('hidden');
                if (generateThemeButton) generateThemeButton.disabled = true;
                if (rerollThemeButton) rerollThemeButton.disabled = true;
                
                // NEW: Updated AI theme generation prompt for better results.
                const prompt = `Generate a complete and cohesive JSON object for a gamified productivity app based on the universe of "${universe}". All fields MUST be filled. The object should have the following keys: "appTitle", "playerTitle", "masterTitle", "skillSectionTitle", "taskTitle", "ranks" (as a string array of exactly 4 titles), "energyTypes" (as a string array of exactly 5 types), "homeNames" (as a string array of exactly 5 names), "groupTitle", "specialityTitle", "universe" (which should be "${universe}"), and "themeColor" (a single hex code color string). Be creative and ensure all terms fit the theme. The response MUST be a single JSON object.`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                             type: "OBJECT",
                             properties: {
                                 "appTitle": { "type": "STRING" },
                                 "playerTitle": { "type": "STRING" },
                                 "masterTitle": { "type": "STRING" },
                                 "skillSectionTitle": { "type": "STRING" },
                                 "taskTitle": { "type": "STRING" },
                                 "ranks": {
                                     "type": "ARRAY",
                                     "items": { "type": "STRING" },
                                     "minItems": 4,
                                     "maxItems": 4
                                 },
                                 "energyTypes": {
                                     "type": "ARRAY",
                                     "items": { "type": "STRING" },
                                     "minItems": 5,
                                     "maxItems": 5
                                 },
                                 "homeNames": {
                                     "type": "ARRAY",
                                     "items": { "type": "STRING" },
                                     "minItems": 5,
                                     "maxItems": 5
                                 },
                                 "groupTitle": { "type": "STRING" },
                                 "specialityTitle": { "type": "STRING" },
                                 "universe": {"type": "STRING"},
                                 "themeColor": { "type": "STRING" }
                             }
                        }
                    }
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let attempts = 0;
                const maxAttempts = 3;
                const baseDelay = 1000;
                let success = false;
                let data = null;

                while (attempts < maxAttempts && !success) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                             throw new Error(`API call failed with status: ${response.status}`);
                        }

                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonString = result.candidates[0].content.parts[0].text;
                            data = JSON.parse(jsonString);
                            success = true;
                        } else {
                            throw new Error('No valid content in API response');
                        }
                    } catch (error) {
                        console.error('Error fetching from API:', error);
                        attempts++;
                        if (attempts < maxAttempts) {
                            const delay = baseDelay * Math.pow(2, attempts - 1) + Math.random() * 1000;
                            await new Promise(res => setTimeout(res, delay));
                        }
                    }
                }

                if (success && data) {
                    if (customAppTitleInput) customAppTitleInput.value = data.appTitle || '';
                    if (customPlayerTitleInput) customPlayerTitleInput.value = data.playerTitle || '';
                    if (customMasterTitleInput) customMasterTitleInput.value = data.masterTitle || '';
                    if (customSkillSectionTitleInput) customSkillSectionTitleInput.value = data.skillSectionTitle || '';
                    if (customTaskTitleInput) customTaskTitleInput.value = data.taskTitle || '';
                    if (customRanksInput && Array.isArray(data.ranks)) customRanksInput.value = data.ranks.join(', ');
                    if (customEnergyTypesInput && Array.isArray(data.energyTypes)) customEnergyTypesInput.value = data.energyTypes.join(', ');
                    if (customHomeNamesInput && Array.isArray(data.homeNames)) customHomeNamesInput.value = data.homeNames.join(', ');
                    if (customGroupTitleInput) customGroupTitleInput.value = data.groupTitle || '';
                    if (customSpecialityTitleInput) customSpecialityTitleInput.value = data.specialityTitle || '';
                    if (customBackgroundUrlInput) customBackgroundUrlInput.value = data.backgroundUrl || '';
                    if (customThemeColorInput) customThemeColorInput.value = data.themeColor || '';
                    customizableTerms.universe = data.universe || 'Fantasy';

                    if (themeGeneratorContent) themeGeneratorContent.classList.add('hidden');
                    if (customizationContent) customizationContent.classList.remove('hidden');
                    if (rerollThemeButton) rerollThemeButton.classList.remove('hidden');
                    if (manualCustomizationTab) manualCustomizationTab.click(); // Switch to manual tab for review
                    showMessageModal("Theme generated! Review and save your changes.");

                } else {
                     showMessageModal('Failed to generate a theme. Please check your network and try again.');
                }
            
                if (themeLoadingIndicator) themeLoadingIndicator.classList.add('hidden');
                if (generateThemeButton) generateThemeButton.disabled = false;
                if (rerollThemeButton) rerollThemeButton.disabled = false;
            };

            if (generateThemeButton) generateThemeButton.addEventListener('click', async () => {
                const universeInput = document.getElementById('universeInput');
                const userUniverse = universeInput.value.trim();
                if (!userUniverse) return;
                await generateAndPopulateTheme(userUniverse);
            });

            if (rerollThemeButton) rerollThemeButton.addEventListener('click', async () => {
                 const universeInput = document.getElementById('universeInput');
                 const userUniverse = universeInput.value.trim();
                 if (!userUniverse) return;
                 await generateAndPopulateTheme(userUniverse);
            });
            
            // --- New Initialization Logic ---
            if (!localStorage.getItem('themeChosen')) {
                // First-time user, show welcome screen.
                welcomeScreen.style.display = 'flex';
                // Wait for the initiate button to be clicked before starting the tutorial flow.
            } else {
                // A returning user, proceed directly to main app initialization.
                initializeMainApp();
            }

            setInterval(checkDailyReset, 60000);
        });
    </script>
</body>
</html>
